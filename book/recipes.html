<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Babashka book</title>
    <link rel="canonical" href="https://book.babashka.org/book/recipes.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="stylesheet" href="../_/css/site-extra.css">
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">-->
<!--<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">-->
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://book.babashka.org">Babashka book</a>
        <!--<span class="separator">//</span>
        <a href="https://book.babashka.org">Docs</a>-->
      </div>
      <!--<div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>-->
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <!--<div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider">CIDER</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider-nrepl">CIDER nREPL</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/orchard">Orchard</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/clojure-mode">clojure-mode</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/cider/about/support.html">Support</a>
            <a class="navbar-item" href="/cider/contributing.html">Contributing</a>
            <a class="navbar-item" href="https://opencollective.com/cider">Open Collective</a>
          </div>
        </div>
      </div>
    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="book" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="book.html">Babashka</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting_started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="usage.html">Usage</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/repl.html">Running a REPL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/classpath.html">Classpath</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/preloads.html">Preloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/io-flags.html">Input and output flags</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="style.html">Style</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="libraries.html">Libraries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pods.html">Pods</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="child_processes.html">Child processes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deps_clj.html">Deps.clj</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="recipes.html">Recipes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="differences.html">Differences with Clojure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="contributing.html">Contributing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="license.html">License</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Babashka</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Babashka</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="book.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="intro.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="book.html">Babashka</a></li>
    <li><a href="recipes.html">Recipes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/borkdude/Dropbox/dev/clojure/babashka.book/src/modules/ROOT/pages/recipes.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="recipes"><a class="anchor" href="#recipes"></a>Recipes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_running_tests"><a class="anchor" href="#_running_tests"></a>Running tests</h3>
<div class="paragraph">
<p>Babashka bundles <code>clojure.test</code>. To make CI scripts fail you can use a
simple runner like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">#!/usr/bin/env bash
bb -cp "src:test:resources" \
   -e "(require '[clojure.test :as t] '[borkdude.deps-test])
       (let [{:keys [:fail :error]} (t/run-tests 'borkdude.deps-test)]
         (System/exit (+ fail error)))"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="main_file"><a class="anchor" href="#main_file"></a>Main file</h3>
<div class="paragraph">
<p>In Python scripts there is a well-known pattern to check if the current
file was the file invoked from the command line, or loaded from another
file: the <code><em>name</em> == "<em>main</em>"</code> pattern. In babashka this pattern can
be implemented with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(= *file* (System/getProperty "babashka.file")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shutdown_hook"><a class="anchor" href="#_shutdown_hook"></a>Shutdown hook</h3>
<div class="paragraph">
<p>Adding a shutdown hook allows you to execute some code before the script
exits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ bb -e '(-&gt; (Runtime/getRuntime) (.addShutdownHook (Thread. #(println "bye"))))'
bye</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also works when the script is interrupted with ctrl-c.</p>
</div>
</div>
<div class="sect2">
<h3 id="_printing_returned_values"><a class="anchor" href="#_printing_returned_values"></a>Printing returned values</h3>
<div class="paragraph">
<p>Babashka doesn&#8217;t print a returned <code>nil</code> as lots of scripts end in
something side-effecting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ bb '(:a {:a 5})'
5
$ bb '(:b {:a 5})'
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you really want to print the nil, you can use <code>(prn ..)</code> instead.</p>
</div>
</div>
<div class="sect2">
<h3 id="_http_requests"><a class="anchor" href="#_http_requests"></a>HTTP requests</h3>
<div class="paragraph">
<p>For making HTTP requests you can use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/borkdude/babashka.curl">babashka.curl</a>. This library
is included with babashka and aliased as <code>curl</code> in the user namespace.
The interface is similar to that of
<a href="https://github.com/dakrone/clj-http">clj-http</a> but it will shell out to
<code>curl</code> to make requests.</p>
</li>
<li>
<p><a href="https://github.com/http-kit/http-kit">org.httpkit.client</a></p>
</li>
<li>
<p><code>slurp</code> for simple <code>GET</code> requests</p>
</li>
<li>
<p><a href="https://github.com/babashka/clj-http-lite">clj-http-lite</a> as a library.</p>
</li>
<li>
<p><code>clojure.java.shell</code> or <code>babashka.process</code> for shelling out to your
favorite command line http client</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_choosing_the_right_client"><a class="anchor" href="#_choosing_the_right_client"></a>Choosing the right client</h4>
<div class="paragraph">
<p>If memory usage is a concern and you are downloading big files, choose
<code>babashka.curl</code> with <code>:as :stream</code> over <code>org.httpkit.client</code> since
http-kit holds the entire response in memory at once. Let&#8217;s download a
200mb file with 10mb heap size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ bb -Xmx10m -e '(io/copy (:body (curl/get "http://ipv4.download.thinkbroadband.com/200MB.zip" {:as :stream})) (io/file "/tmp/200mb.zip"))'</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>babashka.curl</code> this works fine. However with <code>org.httpkit.client</code>
that won&#8217;t work. Not even 190mb of heap will do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ bb -Xmx190m -e '(io/copy (:body @(org.httpkit.client/get "http://ipv4.download.thinkbroadband.com/200MB.zip" {:as :stream})) (io/file "/tmp/200mb.zip"))'
Sun Nov 08 23:01:46 CET 2020 [client-loop] ERROR - select exception, should not happen
java.lang.OutOfMemoryError: Array allocation too large.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your script creates many requests with relatively small payloads,
choose <code>org.httpkit.client</code> over <code>babashka.curl</code> since <code>babashka.curl</code>
creates a <code>curl</code> process for each request.</p>
</div>
<div class="paragraph">
<p>In the future babashka (1.0.0?) may come with an HTTP client based on
the JVM 11 <code>java.net.http</code> package that ticks all the boxes (async,
HTTP/2, websockets, multi-part file uploads, sane memory usage) and is a
suitable replacement for all of the above options. If you know about a
GraalVM-friendly feature-complete well-maintained library, please reach
out!</p>
</div>
</div>
<div class="sect3">
<h4 id="_http_over_unix_sockets"><a class="anchor" href="#_http_over_unix_sockets"></a>HTTP over Unix sockets</h4>
<div class="paragraph">
<p>This can be useful for talking to Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(require '[clojure.java.shell :refer [sh]])
(require '[cheshire.core :as json])
(-&gt; (sh "curl" "--silent"
        "--no-buffer" "--unix-socket"
        "/var/run/docker.sock"
        "http://localhost/images/json")
    :out
    (json/parse-string true)
    first
    :RepoTags) ;;=&gt; ["borkdude/babashka:latest"]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core_async"><a class="anchor" href="#core_async"></a>Core.async</h3>
<div class="paragraph">
<p>In addition to <code>future</code>, <code>pmap</code>, <code>promise</code> and friends, you may use the
<code>clojure.core.async</code> namespace for asynchronous scripting. The following
example shows how to get first available value from two different
processes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">bb '
(defn async-command [&amp; args]
  (async/thread (apply shell/sh "bash" "-c" args)))

(-&gt; (async/alts!! [(async-command "sleep 2 &amp;&amp; echo process 1")
                   (async-command "sleep 1 &amp;&amp; echo process 2")])
    first :out str/trim println)'
process 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveat: currently the <code>go</code> macro is available for compatibility with JVM
programs, but the implementation maps to <code>clojure.core.async/thread</code> and
the single exclamation mark operations (<code>&lt;!</code>, <code>&gt;!</code>, etc.) map to the
double exclamation mark operations (<code>&lt;!!</code>, <code>&gt;!!</code>, etc.). It will not
"park" threads, like on the JVM.</p>
</div>
<div class="paragraph">
<p>Examples like the following may still work, but will take a lot more
system resources than on the JVM and will break down for some high value
of <code>n</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(require '[clojure.core.async :as async])

(def n 1000)

(let [cs (repeatedly n async/chan)
      begin (System/currentTimeMillis)]
  (doseq [c cs] (async/go (async/&gt;! c "hi")))
  (dotimes [_ n]
    (let [[v _] (async/alts!! cs)]
      (assert (= "hi" v))))
  (println "Read" n "msgs in" (- (System/currentTimeMillis) begin) "ms"))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interacting_with_an_nrepl_server"><a class="anchor" href="#_interacting_with_an_nrepl_server"></a>Interacting with an nREPL server</h3>
<div class="paragraph">
<p>Babashka comes with the <a href="https://github.com/nrepl/bencode">nrepl/bencode</a>
library which allows you to read and write bencode messages to a socket.
A simple example which evaluates a Clojure expression on an nREPL server
started with <code>lein repl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns nrepl-client
  (:require [bencode.core :as b]))

(defn nrepl-eval [port expr]
  (let [s (java.net.Socket. "localhost" port)
        out (.getOutputStream s)
        in (java.io.PushbackInputStream. (.getInputStream s))
        _ (b/write-bencode out {"op" "eval" "code" expr})
        bytes (get (b/read-bencode in) "value")]
    (String. bytes)))

(nrepl-eval 52054 "(+ 1 2 3)") ;;=&gt; "6"</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2020 <a href="https://babashka.org">Michiel Borkent</a></p>
  <p>Except where otherwise noted, book.babashka.org is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons
Attribution-NonCommercial-NoDerivs</a> (CC BY-NC-ND 4.0).</p>
</footer>
<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script> -->
<!-- <script type="text/javascript"> -->
<!-- docsearch({ -->
<!--   apiKey: '1f3d78fd63fcb687dcc1312aab02a2de', -->
<!--   indexName: 'cider', -->
<!--   inputSelector: '#search-input', -->
<!--   algoliaOptions: { 'facetFilters': ["version:0.26"] }, -->
<!--   debug: false // Set debug to true if you want to inspect the dropdown -->
<!-- }); -->
<!-- </script> -->

<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
