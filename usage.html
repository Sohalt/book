<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Babashka book</title>
    <link rel="canonical" href="https://book.babashka.org/gh-pages/usage.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="stylesheet" href="../_/css/site-extra.css">
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">-->
<!--<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">-->
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://book.babashka.org">Babashka book</a>
        <!--<span class="separator">//</span>
        <a href="https://book.babashka.org">Docs</a>-->
      </div>
      <!--<div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>-->
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <!--<div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider">CIDER</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider-nrepl">CIDER nREPL</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/orchard">Orchard</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/clojure-mode">clojure-mode</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/cider/about/support.html">Support</a>
            <a class="navbar-item" href="/cider/contributing.html">Contributing</a>
            <a class="navbar-item" href="https://opencollective.com/cider">Open Collective</a>
          </div>
        </div>
      </div>
    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="gh-pages" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="intro.html">Babashka</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting_started.html">Getting started</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="usage.html">Usage</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/repl.html">Running a REPL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/classpath.html">Classpath</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/preloads.html">Preloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/io-flags.html">Input and output flags</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="style.html">Style</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="libraries.html">Libraries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pods.html">Pods</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="child_processes.html">Child processes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deps_clj.html">Deps.clj</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="recipes.html">Recipes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="differences.html">Differences with Clojure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="contributing.html">Contributing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="license.html">License</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Babashka</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Babashka</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="intro.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="intro.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="intro.html">Babashka</a></li>
    <li><a href="usage.html">Usage</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/borkdude/Dropbox/dev/clojure/babashka.book/src/modules/ROOT/pages/usage.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Typing <code>bb --help</code> from the command line will print all the available command
line options which should give you a sense of the available features in
babashka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Babashka v0.2.3

Options must appear in the order of groups mentioned below.

Help:

  --help, -h or -?    Print this help text.
  --version           Print the current version of babashka.
  --describe          Print an EDN map with information about this version of babashka.

In- and output flags:

  -i                  Bind *input* to a lazy seq of lines from stdin.
  -I                  Bind *input* to a lazy seq of EDN values from stdin.
  -o                  Write lines to stdout.
  -O                  Write EDN values to stdout.
  --stream            Stream over lines or EDN values from stdin. Combined with -i or -I *input* becomes a single value per iteration.

Uberscript:

  --uberscript &lt;file&gt; Collect preloads, -e, -f and -m and all required namespaces from the classpath into a single executable file.

Evaluation:

  -e, --eval &lt;expr&gt;   Evaluate an expression.
  -f, --file &lt;path&gt;   Evaluate a file.
  -cp, --classpath    Classpath to use.
  -m, --main &lt;ns&gt;     Call the -main function from namespace with args.
  --verbose           Print debug information and entire stacktrace in case of exception.

REPL:

  --repl              Start REPL. Use rlwrap for history.
  --socket-repl       Start socket REPL. Specify port (e.g. 1666) or host and port separated by colon (e.g. 127.0.0.1:1666).
  --nrepl-server      Start nREPL server. Specify port (e.g. 1667) or host and port separated by colon (e.g. 127.0.0.1:1667).

If neither -e, -f, or --socket-repl are specified, then the first argument that is not parsed as a option is treated as a file if it exists, or as an expression otherwise. Everything after that is bound to *command-line-args*. Use -- to separate script command line args from bb command line args.</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_running_a_script"><a class="anchor" href="#_running_a_script"></a>Running a script</h3>
<div class="paragraph">
<p>Scripts may be executed from a file using <code>-f</code> or <code>--file</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">bb -f download_html.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>bb</code> with a shebang also works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">#!/usr/bin/env bb

(require '[babashka.curl :as curl])

(defn get-url [url]
  (println "Downloading url:" url)
  (curl/get url))

(defn write-html [file html]
  (println "Writing file:" file)
  (spit file html))

(let [[url file] *command-line-args*]
  (when (or (empty? url) (empty? file))
    (println "Usage: &lt;url&gt; &lt;file&gt;")
    (System/exit 1))
  (write-html file (get-url url)))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./download_html.clj
Usage: &lt;url&gt; &lt;file&gt;

$ ./download_html.clj https://www.clojure.org /tmp/clojure.org.html
Fetching url: https://www.clojure.org
Writing file: /tmp/clojure.org.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>/usr/bin/env</code> doesn&#8217;t work for you, you can use the following
workaround:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat script.clj
#!/bin/sh

#_(
   "exec" "bb" "$0" hello "$@"
   )

(prn *command-line-args*)

./script.clj 1 2 3
("hello" "1" "2" "3")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_current_file_path"><a class="anchor" href="#_current_file_path"></a>Current file path</h3>
<div class="paragraph">
<p>The var <code><strong>file</strong></code> contains the full path of the file that is currently
being executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat example.clj
(prn *file*)

$ bb example.clj
"/Users/borkdude/example.clj"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_command_line_arguments"><a class="anchor" href="#_command_line_arguments"></a>Command-line arguments</h3>
<div class="paragraph">
<p>Command-line arguments can be retrieved using <code><strong>command-line-args</strong></code>. If
you want to parse command line arguments, you may use the built-in
<code>clojure.tools.cli</code> namespace (see
<a href="https://github.com/borkdude/babashka#parsing-command-line-arguments">docs</a>)
or use the
<a href="https://github.com/borkdude/babashka/blob/master/doc/projects.md#nubankdocopt">nubank/docopt</a>
library.</p>
</div>
</div>
<div class="sect2">
<h3 id="_uberscript"><a class="anchor" href="#_uberscript"></a>Uberscript</h3>
<div class="paragraph">
<p>The <code>--uberscript</code> option collects the expressions in
<code>BABASHKA_PRELOADS</code>, the command line expression or file, the main
entrypoint and all required namespaces from the classpath into a single
file. This can be convenient for debugging and deployment.</p>
</div>
<div class="paragraph">
<p>Here is an example that uses a function from the
<a href="https://github.com/clj-commons/fs">clj-commons/fs</a> library.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first set the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ export BABASHKA_CLASSPATH=$(clojure -Spath -Sdeps '{:deps {clj-commons/fs {:mvn/version "1.5.2"}}}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a little script, say <code>glob.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns foo (:require [me.raynes.fs :as fs]))
(run! (comp println str)
      (fs/glob (first *command-line-args*)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can execute the script which uses the library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time bb glob.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob.clj '*.md'   0.03s  user 0.02s system 70% cpu 0.064 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Producing an uberscript with all required code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ bb -f glob.clj --uberscript glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>To prove that we don&#8217;t need the classpath anymore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ unset BABASHKA_CLASSPATH
$ time bb glob-uberscript.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj '*.md'   0.03s  user 0.02s system 93% cpu 0.049 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Dynamic requires</em>. Building uberscripts works by running top-level
<code>ns</code> and <code>require</code> forms. The rest of the code is not evaluated. Code
that relies on dynamic requires may not work in an uberscript.</p>
</li>
<li>
<p><em>Resources</em>. The usage of <code>io/resource</code> assumes a classpath, so when
this is used in your uberscript, you still have to set a classpath and
bring the resources along.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of the above is problematic for your project, using an
<a href="#uberjar">uberjar</a> is a good alternative.</p>
</div>
</div>
<div class="sect2">
<h3 id="_carve"><a class="anchor" href="#_carve"></a>Carve</h3>
<div class="paragraph">
<p>Uberscripts can be optimized by cutting out unused vars with
<a href="https://github.com/borkdude/carve">carve</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ wc -l glob-uberscript.clj
     607 glob-uberscript.clj
$ clojure -M:carve --opts '{:paths ["glob-uberscript.clj"] :aggressive true :silent true}'
$ wc -l glob-uberscript.clj
     172 glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the uberscript became 72% shorter. This has a beneficial
effect on execution time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time bb glob-uberscript.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj '*.md'   0.02s  user 0.01s system 93% cpu 0.032 total</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_uberjar"><a class="anchor" href="#_uberjar"></a>Uberjar</h3>
<div class="paragraph">
<p>Babashka can create uberjars from a given classpath and optionally a
main method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ cat src/foo.clj
(ns foo (:gen-class)) (defn -main [&amp; args] (prn :hello))
$ bb -cp $(clojure -Spath) -m foo --uberjar foo.jar
$ bb foo.jar
:hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>When producing a classpath using the <code>clojure</code> or <code>deps.clj</code> tool,
Clojure itself, spec and the core specs will be on the classpath and
will therefore be included in your uberjar, which makes it bigger than
necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ls -lh foo.jar
-rw-r--r--  1 borkdude  staff   4.5M Aug 19 17:04 foo.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>To exclude these dependencies, you can use the following
<code>:classpath-overrides</code> in your <code>deps.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">{:aliases {:remove-clojure {:classpath-overrides {org.clojure/clojure nil
                                                  org.clojure/spec.alpha nil
                                                  org.clojure/core.specs.alpha nil}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ rm foo.jar
$ bb -cp $(clojure -A:remove-clojure -Spath) -m foo --uberjar foo.jar
$ bb foo.jar
:hello
$ ls -lh foo.jar
-rw-r--r--  1 borkdude  staff   871B Aug 19 17:07 foo.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want your uberjar to be compatible with the JVM, you&#8217;ll need to
compile the main namespace. Babashka does not do compilation, so we use
Clojure on the JVM for that part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ rm foo.jar
$ mkdir classes
$ clojure -e "(require 'foo) (compile 'foo)"
foo
$ bb -cp $(clojure -Spath):classes -m foo --uberjar foo.jar
$ bb foo.jar
:hello
$ java -jar foo.jar
:hello</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_system_properties"><a class="anchor" href="#_system_properties"></a>System properties</h3>
<div class="paragraph">
<p>Babashka sets the following system properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>babashka.version</code>: the version string, e.g. <code>"1.2.0"</code></p>
</li>
<li>
<p><code>babashka.main</code>: the <code>--main</code> argument</p>
</li>
<li>
<p><code>babashka.file</code>: the <code>--file</code> argument (normalized using
<code>.getAbsolutePath</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_data_readers"><a class="anchor" href="#_data_readers"></a>Data readers</h3>
<div class="paragraph">
<p>Data readers can be enabled by setting <code><strong>data-readers</strong></code> to a hashmap of
symbols to functions or vars:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ bb "(set! *data-readers* {'t/tag inc}) #t/tag 1"
2</code></pre>
</div>
</div>
<div class="paragraph">
<p>To preserve good startup time, babashka does not scan the classpath for
<code>data_readers.clj</code> files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parsing_command_line_arguments"><a class="anchor" href="#_parsing_command_line_arguments"></a>Parsing command line arguments</h3>
<div class="paragraph">
<p>Babashka ships with <code>clojure.tools.cli</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(require '[clojure.tools.cli :refer [parse-opts]])

(def cli-options
  ;; An option with a required argument
  [["-p" "--port PORT" "Port number"
    :default 80
    :parse-fn #(Integer/parseInt %)
    :validate [#(&lt; 0 % 0x10000) "Must be a number between 0 and 65536"]]
   ["-h" "--help"]])

(:options (parse-opts *command-line-args* cli-options))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ bb script.clj
{:port 80}
$ bb script.clj -h
{:port 80, :help true}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reader_conditionals"><a class="anchor" href="#_reader_conditionals"></a>Reader conditionals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Babashka supports reader conditionals by taking either the <code>:bb</code> or
<code>:clj</code> branch, whichever comes first. NOTE: the <code>:clj</code> branch behavior
was added in version 0.0.71, before that version the <code>:clj</code> branch was
ignored.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ bb "#?(:bb :hello :clj :bye)"
:hello

$ bb "#?(:clj :bye :bb :hello)"
:bye

$ bb "[1 2 #?@(:bb [] :clj [1])]"
[1 2]</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2020 <a href="https://babashka.org">Michiel Borkent</a></p>
  <p>Except where otherwise noted, book.babashka.org is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons
Attribution-NonCommercial-NoDerivs</a> (CC BY-NC-ND 4.0).</p>
</footer>
<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script> -->
<!-- <script type="text/javascript"> -->
<!-- docsearch({ -->
<!--   apiKey: '1f3d78fd63fcb687dcc1312aab02a2de', -->
<!--   indexName: 'cider', -->
<!--   inputSelector: '#search-input', -->
<!--   algoliaOptions: { 'facetFilters': ["version:0.26"] }, -->
<!--   debug: false // Set debug to true if you want to inspect the dropdown -->
<!-- }); -->
<!-- </script> -->

<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
