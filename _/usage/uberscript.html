<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Babashka book</title>
    <link rel="canonical" href="https://book.babashka.org/_/usage/uberscript.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/site-extra.css">
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">-->
<!--<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">-->
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://book.babashka.org">Babashka book</a>
        <!--<span class="separator">//</span>
        <a href="https://book.babashka.org">Docs</a>-->
      </div>
      <!--<div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>-->
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <!--<div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider">CIDER</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider-nrepl">CIDER nREPL</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/orchard">Orchard</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/clojure-mode">clojure-mode</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/cider/about/support.html">Support</a>
            <a class="navbar-item" href="/cider/contributing.html">Contributing</a>
            <a class="navbar-item" href="https://opencollective.com/cider">Open Collective</a>
          </div>
        </div>
      </div>
    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="_" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../intro.html">Babashka</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting_started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Usage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../usage.html">General usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repl.html">Running a REPL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="classpath.html">Classpath</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="preloads.html">Preloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="io-flags.html">Input and output flags</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="uberscript.html">Uberscript</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uberjar.html">Uberjar</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../style.html">Style</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../libraries.html">Libraries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pods.html">Pods</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../child_processes.html">Child processes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../deps_clj.html">Deps.clj</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../recipes.html">Recipes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../differences.html">Differences with Clojure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../contributing.html">Contributing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../license.html">License</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Babashka</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Babashka</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../intro.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../intro.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../intro.html">Babashka</a></li>
    <li>Usage</li>
    <li><a href="uberscript.html">Uberscript</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/borkdude/Dropbox/dev/clojure/babashka.book/src/modules/ROOT/pages/usage/uberscript.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_uberscript"><a class="anchor" href="#_uberscript"></a>Uberscript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>--uberscript</code> option collects the expressions in
<code>BABASHKA_PRELOADS</code>, the command line expression or file, the main
entrypoint and all required namespaces from the classpath into a single
file. This can be convenient for debugging and deployment.</p>
</div>
<div class="paragraph">
<p>Here is an example that uses a function from the
<a href="https://github.com/clj-commons/fs">clj-commons/fs</a> library.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first set the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">$ export BABASHKA_CLASSPATH=$(clojure -Spath -Sdeps '{:deps {clj-commons/fs {:mvn/version "1.5.2"}}}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a little script, say <code>glob.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns foo (:require [me.raynes.fs :as fs]))
(run! (comp println str)
      (fs/glob (first *command-line-args*)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can execute the script which uses the library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time bb glob.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob.clj '*.md'   0.03s  user 0.02s system 70% cpu 0.064 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Producing an uberscript with all required code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ bb -f glob.clj --uberscript glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>To prove that we don&#8217;t need the classpath anymore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ unset BABASHKA_CLASSPATH
$ time bb glob-uberscript.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj '*.md'   0.03s  user 0.02s system 93% cpu 0.049 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Dynamic requires</em>. Building uberscripts works by running top-level
<code>ns</code> and <code>require</code> forms. The rest of the code is not evaluated. Code
that relies on dynamic requires may not work in an uberscript.</p>
</li>
<li>
<p><em>Resources</em>. The usage of <code>io/resource</code> assumes a classpath, so when
this is used in your uberscript, you still have to set a classpath and
bring the resources along.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of the above is problematic for your project, using an
<a href="#uberjar">uberjar</a> is a good alternative.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_carve"><a class="anchor" href="#_carve"></a>Carve</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Uberscripts can be optimized by cutting out unused vars with
<a href="https://github.com/borkdude/carve">carve</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ wc -l glob-uberscript.clj
     607 glob-uberscript.clj
$ clojure -M:carve --opts '{:paths ["glob-uberscript.clj"] :aggressive true :silent true}'
$ wc -l glob-uberscript.clj
     172 glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the uberscript became 72% shorter. This has a beneficial
effect on execution time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ time bb glob-uberscript.clj '*.md'
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj '*.md'   0.02s  user 0.01s system 93% cpu 0.032 total</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2020 <a href="https://babashka.org">Michiel Borkent</a></p>
  <p>Except where otherwise noted, book.babashka.org is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons
Attribution-NonCommercial-NoDerivs</a> (CC BY-NC-ND 4.0).</p>
</footer>
<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script> -->
<!-- <script type="text/javascript"> -->
<!-- docsearch({ -->
<!--   apiKey: '1f3d78fd63fcb687dcc1312aab02a2de', -->
<!--   indexName: 'cider', -->
<!--   inputSelector: '#search-input', -->
<!--   algoliaOptions: { 'facetFilters': ["version:0.26"] }, -->
<!--   debug: false // Set debug to true if you want to inspect the dropdown -->
<!-- }); -->
<!-- </script> -->

<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
