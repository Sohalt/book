<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="description" content="A book with scripting recipes for babashka">
<meta name="author" content="Michiel Borkent">
<title>Babashka book</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Babashka book</h1>
<div class="details">
<span id="author" class="author">Michiel Borkent</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#contributing">Contributing</a></li>
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_target_audience">Target audience</a></li>
<li><a href="#_setting_expectations">Setting expectations</a></li>
</ul>
</li>
<li><a href="#getting_started">Getting started</a>
<ul class="sectlevel2">
<li><a href="#_installation">Installation</a></li>
<li><a href="#_building_from_source">Building from source</a></li>
<li><a href="#_running_babashka">Running babashka</a></li>
</ul>
</li>
<li><a href="#usage">Usage</a>
<ul class="sectlevel2">
<li><a href="#_running_a_script">Running a script</a></li>
<li><a href="#_input_and_output_flags">Input and output flags</a></li>
<li><a href="#_current_file_path">Current file path</a></li>
<li><a href="#_command_line_arguments">Command-line arguments</a></li>
<li><a href="#repl">Running a REPL</a></li>
<li><a href="#_preloads">Preloads</a></li>
<li><a href="#_classpath">Classpath</a></li>
<li><a href="#_uberscript">Uberscript</a></li>
<li><a href="#_uberjar">Uberjar</a></li>
<li><a href="#_system_properties">System properties</a></li>
<li><a href="#_data_readers">Data readers</a></li>
<li><a href="#_parsing_command_line_arguments">Parsing command line arguments</a></li>
<li><a href="#_reader_conditionals">Reader conditionals</a></li>
</ul>
</li>
<li><a href="#style">Style</a>
<ul class="sectlevel2">
<li><a href="#_explicit_requires">Explicit requires</a></li>
</ul>
</li>
<li><a href="#libraries">Libraries</a>
<ul class="sectlevel2">
<li><a href="#_built_in_namespaces">Built-in namespaces</a></li>
<li><a href="#_babashka_namespaces">Babashka namespaces</a></li>
</ul>
</li>
<li><a href="#child_processes">Child processes</a>
<ul class="sectlevel2">
<li><a href="#_clojure_java_shell">clojure.java.shell</a></li>
<li><a href="#_babashka_process">babashka.process</a></li>
</ul>
</li>
<li><a href="#deps_clj">Deps.clj</a></li>
<li><a href="#recipes">Recipes</a>
<ul class="sectlevel2">
<li><a href="#_running_tests">Running tests</a></li>
<li><a href="#main_file">Main file</a></li>
<li><a href="#_shutdown_hook">Shutdown hook</a></li>
<li><a href="#_printing_returned_values">Printing returned values</a></li>
<li><a href="#_http_requests">HTTP requests</a></li>
<li><a href="#core_async">Core.async</a></li>
<li><a href="#_interacting_with_an_nrepl_server">Interacting with an nREPL server</a></li>
</ul>
</li>
<li><a href="#differences-with-clojure">Differences with Clojure</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!--<script>alert('hello')</script>-->
</div>
</div>
<div class="sect1">
<h2 id="contributing">Contributing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Visit Babashka book&#8217;s <a href="https://github.com/babashka/book">Github repository</a> and read
<a href="https://github.com/babashka/book/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>
on how to contribute.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome reader! This is a book about scripting with Clojure and babashka.
<a href="https://www.clojure.org">Clojure</a> is a functional, dynamic programming language
from the Lisp family which runs on the JVM. Babashka is a scripting environment
made with Clojure, compiled to native with <a href="https://www.graalvm.org">GraalVM</a>. The
primary benefits of using babashka for scripting compared to the JVM are fast
startup time and low memory consumption. Babashka comes with batteries included
and packs libraries like <code>clojure.tools.cli</code> for parsing command line arguments
and <code>cheshire</code> for working with JSON. Moreover, it can be installed just by
downloading a self-contained binary.</p>
</div>
<div class="sect2">
<h3 id="_target_audience">Target audience</h3>
<div class="paragraph">
<p>Babashka is written for developers who are familiar with Clojure on
the JVM. This book assumes familiarity with Clojure and is not a Clojure
tutorial. If you aren&#8217;t that familiar with Clojure but you&#8217;re curious to learn,
check out <a href="https://gist.github.com/yogthos/be323be0361c589570a6da4ccc85f58f">this</a>
list of beginner resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_expectations">Setting expectations</h3>
<div class="paragraph">
<p>Babashka uses <a href="https://github.com/borkdude/sci">sci</a> for interpreting Clojure. Sci
implements a substantial subset of Clojure. Interpreting code is in general not
as performant as executing compiled code. If your script takes more than a few
seconds to run or has lots of loops, Clojure on the JVM may be a better fit,
since the performance of Clojure on the JVM outweighs its startup time
penalty. Read more about the differences with Clojure
<a href="#differences-with-clojure">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting_started">Getting started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation">Installation</h3>
<div class="paragraph">
<p>Installing babashka is as simple as downloading the binary for your platform and
placing it on your path. Pre-built binaries are provided on the
<a href="https://github.com/borkdude/babashka/releases">releases</a> page of babashka&#8217;s
<a href="https://github.com/borkdude/babashka">Github repo</a>. Babashka is also available in
various package managers like <code>brew</code> for macOS and linux and <code>scoop</code> for
Windows. See <a href="https://github.com/borkdude/babashka#installation">here</a> for
details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_from_source">Building from source</h3>
<div class="paragraph">
<p>If you would rather build babashka from source, download a copy of GraalVM and
set the <code>GRAALVM_HOME</code> environment variable. Also make sure you have
<a href="https://leiningen.org">lein</a> installed. Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$ git clone https://github.com/borkdude/babashka --recursive
$ script/uberjar &amp;&amp; script/compile</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the babashka <a href="https://github.com/borkdude/babashka/blob/master/doc/build.md">build.md</a> page for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_babashka">Running babashka</h3>
<div class="paragraph">
<p>The babashka executable is called <code>bb</code>. You can either provide it with a Clojure
expression directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="o">'</span><span class="w">
</span><span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or run a script:</p>
</div>
<div class="listingblock">
<div class="title">script.clj</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-f</span><span class="w"> </span><span class="n">script.clj</span><span class="w">
</span><span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-e</code> flag is optional when the argument starts with a paren. In that case babashka will treat it automatically as an expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="o">'</span><span class="w">
</span><span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, the <code>-f</code> flag is optional when the argument is a filename:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">script.clj</span><span class="w">
</span><span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Commonly, scripts have shebangs so you can invoke them with their filename only:</p>
</div>
<div class="listingblock">
<div class="title">script.clj</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="o">#</span><span class="n">!/usr/bin/env</span><span class="w"> </span><span class="n">bb</span><span class="w">
</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage">Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Typing <code>bb --help</code> from the command line will print all the available command
line options which should give you a sense of the available features in
babashka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">Babashka v0.2.3

Options must appear <span class="k">in </span>the order of <span class="nb">groups </span>mentioned below.

Help:

  <span class="nt">--help</span>, <span class="nt">-h</span> or -?    Print this <span class="nb">help </span>text.
  <span class="nt">--version</span>           Print the current version of babashka.
  <span class="nt">--describe</span>          Print an EDN map with information about this version of babashka.

In- and output flags:

  <span class="nt">-i</span>                  Bind <span class="k">*</span>input<span class="k">*</span> to a lazy <span class="nb">seq </span>of lines from stdin.
  <span class="nt">-I</span>                  Bind <span class="k">*</span>input<span class="k">*</span> to a lazy <span class="nb">seq </span>of EDN values from stdin.
  <span class="nt">-o</span>                  Write lines to stdout.
  <span class="nt">-O</span>                  Write EDN values to stdout.
  <span class="nt">--stream</span>            Stream over lines or EDN values from stdin. Combined with <span class="nt">-i</span> or <span class="nt">-I</span> <span class="k">*</span>input<span class="k">*</span> becomes a single value per iteration.

Uberscript:

  <span class="nt">--uberscript</span> &lt;file&gt; Collect preloads, <span class="nt">-e</span>, <span class="nt">-f</span> and <span class="nt">-m</span> and all required namespaces from the classpath into a single executable file.

Evaluation:

  <span class="nt">-e</span>, <span class="nt">--eval</span> &lt;<span class="nb">expr</span><span class="o">&gt;</span>   Evaluate an expression.
  <span class="nt">-f</span>, <span class="nt">--file</span> &lt;path&gt;   Evaluate a file.
  <span class="nt">-cp</span>, <span class="nt">--classpath</span>    Classpath to use.
  <span class="nt">-m</span>, <span class="nt">--main</span> &lt;ns&gt;     Call the <span class="nt">-main</span> <span class="k">function </span>from namespace with args.
  <span class="nt">--verbose</span>           Print debug information and entire stacktrace <span class="k">in case</span> of exception.

REPL:

  <span class="nt">--repl</span>              Start REPL. Use rlwrap <span class="k">for </span>history.
  <span class="nt">--socket-repl</span>       Start socket REPL. Specify port <span class="o">(</span>e.g. 1666<span class="p">)</span> or host and port separated by colon <span class="o">(</span>e.g. 127.0.0.1:1666<span class="o">)</span><span class="nb">.</span>
  <span class="nt">--nrepl-server</span>      Start nREPL server. Specify port <span class="o">(</span>e.g. 1667<span class="o">)</span> or host and port separated by colon <span class="o">(</span>e.g. 127.0.0.1:1667<span class="o">)</span><span class="nb">.</span>

If neither <span class="nt">-e</span>, <span class="nt">-f</span>, or <span class="nt">--socket-repl</span> are specified, <span class="k">then </span>the first argument that is not parsed as a option is treated as a file <span class="k">if </span>it exists, or as an expression otherwise. Everything after that is bound to <span class="k">*</span>command-line-args<span class="k">*</span><span class="nb">.</span> Use <span class="nt">--</span> to separate script <span class="nb">command </span>line args from bb <span class="nb">command </span>line args.</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_running_a_script">Running a script</h3>
<div class="paragraph">
<p>Scripts may be executed from a file using <code>-f</code> or <code>--file</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">bb <span class="nt">-f</span> download_html.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>bb</code> with a shebang also works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="o">#</span><span class="n">!/usr/bin/env</span><span class="w"> </span><span class="n">bb</span><span class="w">

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">babashka.curl</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">curl</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">get-url</span><span class="w"> </span><span class="p">[</span><span class="n">url</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Downloading url:"</span><span class="w"> </span><span class="n">url</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">curl/get</span><span class="w"> </span><span class="n">url</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">write-html</span><span class="w"> </span><span class="p">[</span><span class="n">file</span><span class="w"> </span><span class="n">html</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Writing file:"</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">html</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">url</span><span class="w"> </span><span class="n">file</span><span class="p">]</span><span class="w"> </span><span class="n">*command-line-args*</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="n">file</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Usage: &lt;url&gt; &lt;file&gt;"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">System/exit</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">
  </span><span class="p">(</span><span class="nf">write-html</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">(</span><span class="nf">get-url</span><span class="w"> </span><span class="n">url</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>./download_html.clj
Usage: &lt;url&gt; &lt;file&gt;

<span class="nv">$ </span>./download_html.clj https://www.clojure.org /tmp/clojure.org.html
Fetching url: https://www.clojure.org
Writing file: /tmp/clojure.org.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>/usr/bin/env</code> doesn&#8217;t work for you, you can use the following
workaround:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat </span>script.clj
<span class="c">#!/bin/sh</span>

<span class="c">#_(</span>
   <span class="s2">"exec"</span> <span class="s2">"bb"</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span> hello <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
   <span class="o">)</span>

<span class="o">(</span>prn <span class="k">*</span>command-line-args<span class="k">*</span><span class="o">)</span>

./script.clj 1 2 3
<span class="o">(</span><span class="s2">"hello"</span> <span class="s2">"1"</span> <span class="s2">"2"</span> <span class="s2">"3"</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_input_and_output_flags">Input and output flags</h3>
<div class="paragraph">
<p>In one-liners the <code>*input*</code> value may come in handy. It contains the
input read from stdin as EDN by default. If you want to read in text,
use the <code>-i</code> flag, which binds <code>*input*</code> to a lazy seq of lines of text.
If you want to read multiple EDN values, use the <code>-I</code> flag. The <code>-o</code>
option prints the result as lines of text. The <code>-O</code> option prints the
result as lines of EDN values.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> <code>*input*</code> is only available in the <code>user</code> namespace, designed
for one-liners. For writing scripts, see <a href="#scripts">scripts</a>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The following table illustrates the combination of options for commands
of the form</p>
</div>
<div class="literalblock">
<div class="content">
<pre>echo "{{Input}}" | bb {{Input flags}} {{Output flags}} "*input*"</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Input</th>
<th class="tableblock halign-left valign-top">Input flags</th>
<th class="tableblock halign-left valign-top">Output flag</th>
<th class="tableblock halign-left valign-top"><code>*input*</code></th>
<th class="tableblock halign-left valign-top">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code> <code>{:a 2}</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hello bye</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-i</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>("hello" "bye")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>("hello" "bye")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hello bye</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-i</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-o</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>("hello" "bye")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hello bye</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code> <code>{:a 2}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-I</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>({:a 1} {:a 2})</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>({:a 1} {:a 2})</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code> <code>{:a 2}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-I</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-O</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>({:a 1} {:a 2})</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:a 1}</code> <code>{:a 2}</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When combined with the <code>--stream</code> option, the expression is executed for
each value in the input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="o">'</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="o">'</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">--stream</span><span class="w"> </span><span class="ss">'*input*</span><span class="o">'</span><span class="w">
</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_scripts">Scripts</h4>
<div class="paragraph">
<p>When writing scripts instead of one-liners on the command line, it is
not recommended to use <code>*input*</code>. Here is how you can rewrite to
standard Clojure code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_edn_input">EDN input</h4>
<div class="paragraph">
<p>Reading a single EDN value from stdin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">script</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.edn</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">edn</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">edn/read</span><span class="w"> </span><span class="n">*in*</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reading multiple EDN values from stdin (the <code>-I</code> flag):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">script</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.edn</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">edn</span><span class="p">]</span><span class="w">
           </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reader</span><span class="w">  </span><span class="p">(</span><span class="nf">java.io.PushbackReader.</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">*in*</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nb">take-while</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">identical?</span><span class="w"> </span><span class="no">::eof</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">repeatedly</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">edn/read</span><span class="w"> </span><span class="p">{</span><span class="no">:eof</span><span class="w"> </span><span class="no">::eof</span><span class="p">}</span><span class="w"> </span><span class="n">reader</span><span class="p">))))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_text_input">Text input</h4>
<div class="paragraph">
<p>Reading text from stdin can be done with <code>(slurp *in*)</code>. To get a lazy
seq of lines (the <code>-i</code> flag), you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">script</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nb">line-seq</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">*in*</span><span class="p">))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_output">Output</h4>
<div class="paragraph">
<p>To print to stdout, use <code>println</code> for text and <code>prn</code> for EDN values.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_current_file_path">Current file path</h3>
<div class="paragraph">
<p>The var <code>*file*</code> contains the full path of the file that is currently
being executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat </span>example.clj
<span class="o">(</span>prn <span class="k">*</span>file<span class="k">*</span><span class="o">)</span>

<span class="nv">$ </span>bb example.clj
<span class="s2">"/Users/borkdude/example.clj"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_command_line_arguments">Command-line arguments</h3>
<div class="paragraph">
<p>Command-line arguments can be retrieved using <code>*command-line-args*</code>. If
you want to parse command line arguments, you may use the built-in
<code>clojure.tools.cli</code> namespace (see
<a href="https://github.com/borkdude/babashka#parsing-command-line-arguments">docs</a>)
or use the
<a href="https://github.com/borkdude/babashka/blob/master/doc/projects.md#nubankdocopt">nubank/docopt</a>
library.</p>
</div>
</div>
<div class="sect2">
<h3 id="repl">Running a REPL</h3>
<div class="paragraph">
<p>Babashka supports running a REPL, a socket REPL and an nREPL server.</p>
</div>
<div class="sect3">
<h4 id="_repl">REPL</h4>
<div class="paragraph">
<p>To start a REPL, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb <span class="nt">--repl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To get history with up and down arrows, use <a href="https://github.com/hanslub42/rlwrap">rlwrap</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>rlwrap bb <span class="nt">--repl</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_socket_repl">Socket REPL</h4>
<div class="paragraph">
<p>To start a socket REPL on port <code>1666</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb <span class="nt">--socket-repl</span> 1666
Babashka socket REPL started at localhost:1666</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can connect with your favorite socket REPL client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>rlwrap nc 127.0.0.1 1666
Babashka v0.0.14 REPL.
Use :repl/quit or :repl/exit to quit the REPL.
Clojure rocks, Bash reaches.

<span class="nv">bb</span><span class="o">=&gt;</span> <span class="o">(</span>+ 1 2 3<span class="o">)</span>
6
<span class="nv">bb</span><span class="o">=&gt;</span> :repl/quit
<span class="err">$</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--socket-repl</code> option takes options similar to the <code>clojure.server.repl</code>
Java property option in Clojure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">--socket-repl</span><span class="w"> </span><span class="o">'</span><span class="p">{</span><span class="no">:address</span><span class="w"> </span><span class="s">"0.0.0.0"</span><span class="w"> </span><span class="no">:accept</span><span class="w"> </span><span class="n">clojure.core.server/repl</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="mi">1666</span><span class="p">}</span><span class="o">'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Editor plugins and tools known to work with a babashka socket REPL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Emacs: <a href="https://github.com/clojure-emacs/inf-clojure">inf-clojure</a>:</p>
<div class="paragraph">
<p>To connect:</p>
</div>
<div class="paragraph">
<p><code>M-x inf-clojure-connect &lt;RET&gt; localhost &lt;RET&gt; 1666</code></p>
</div>
<div class="paragraph">
<p>Before evaluating from a Clojure buffer:</p>
</div>
<div class="paragraph">
<p><code>M-x inf-clojure-minor-mode</code></p>
</div>
</li>
<li>
<p>Atom: <a href="https://github.com/mauricioszabo/atom-chlorine">Chlorine</a></p>
</li>
<li>
<p>Vim: <a href="https://github.com/liquidz/vim-iced">vim-iced</a></p>
</li>
<li>
<p>IntelliJ IDEA: <a href="https://cursive-ide.com/">Cursive</a></p>
<div class="paragraph">
<p>Note: you will have to use a workaround via
<a href="https://github.com/mfikes/tubular">tubular</a>. For more info, look
<a href="https://cursive-ide.com/userguide/repl.html#repl-types">here</a>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_prepl">pREPL</h4>
<div class="paragraph">
<p>Launching a prepl can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">--socket-repl</span><span class="w"> </span><span class="o">'</span><span class="p">{</span><span class="no">:address</span><span class="w"> </span><span class="s">"0.0.0.0"</span><span class="w"> </span><span class="no">:accept</span><span class="w"> </span><span class="n">clojure.core.server/io-prepl</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="mi">1666</span><span class="p">}</span><span class="o">'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">clojure.core.server/io-prepl</span><span class="p">)</span><span class="o">'</span><span class="w">
</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:tag</span><span class="w"> </span><span class="no">:ret,</span><span class="w"> </span><span class="no">:val</span><span class="w"> </span><span class="s">"6"</span><span class="n">,</span><span class="w"> </span><span class="no">:ns</span><span class="w"> </span><span class="s">"user"</span><span class="n">,</span><span class="w"> </span><span class="no">:ms</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:form</span><span class="w"> </span><span class="s">"(+ 1 2 3)"</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nrepl">nREPL</h4>
<div class="paragraph">
<p>To start an nREPL server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb <span class="nt">--nrepl-server</span> 1667</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then connect with your favorite nREPL client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">lein</span><span class="w"> </span><span class="n">repl</span><span class="w"> </span><span class="no">:connect</span><span class="w"> </span><span class="mi">1667</span><span class="w">
</span><span class="n">Connecting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">nREPL</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mf">127.0</span><span class="n">.0.1</span><span class="no">:1667</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="mi">6</span><span class="w">
</span><span class="n">user=&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Editor plugins and tools known to work with the babashka nREPL server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Emacs: <a href="https://docs.cider.mx/cider/platforms/babashka.html">CIDER</a></p>
</li>
<li>
<p><code>lein repl :connect</code></p>
</li>
<li>
<p>VSCode: <a href="http://calva.io/">Calva</a></p>
</li>
<li>
<p>Atom: <a href="https://github.com/mauricioszabo/atom-chlorine">Chlorine</a></p>
</li>
<li>
<p>(Neo)Vim: <a href="https://github.com/liquidz/vim-iced">vim-iced</a>,
<a href="https://github.com/Olical/conjure">conjure</a>,
<a href="https://github.com/tpope/vim-fireplace">fireplace</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The babashka nREPL server does not write an <code>.nrepl-port</code> file at
startup, but you can easily write a script that launches the server and
writes the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="o">#</span><span class="n">!/usr/bin/env</span><span class="w"> </span><span class="n">bb</span><span class="w">

</span><span class="p">(</span><span class="nb">import</span><span class="w"> </span><span class="p">[</span><span class="n">java.net</span><span class="w"> </span><span class="n">ServerSocket</span><span class="p">]</span><span class="w">
        </span><span class="p">[</span><span class="n">java.io</span><span class="w"> </span><span class="n">File</span><span class="p">]</span><span class="w">
        </span><span class="p">[</span><span class="n">java.lang</span><span class="w"> </span><span class="n">ProcessBuilder$Redirect</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">babashka.wait</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">wait</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">nrepl-port</span><span class="w"> </span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">sock</span><span class="w"> </span><span class="p">(</span><span class="nf">ServerSocket.</span><span class="w"> </span><span class="mi">0</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">.getLocalPort</span><span class="w"> </span><span class="n">sock</span><span class="p">))</span><span class="w">
      </span><span class="n">cp</span><span class="w"> </span><span class="p">(</span><span class="nf">str/join</span><span class="w"> </span><span class="n">File/pathSeparatorChar</span><span class="w"> </span><span class="p">[</span><span class="s">"src"</span><span class="w"> </span><span class="s">"test"</span><span class="p">])</span><span class="w">
      </span><span class="n">pb</span><span class="w"> </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="p">(</span><span class="nf">ProcessBuilder.</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="p">[</span><span class="s">"bb"</span><span class="w"> </span><span class="s">"--nrepl-server"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">nrepl-port</span><span class="p">)</span><span class="w">
                                       </span><span class="s">"--classpath"</span><span class="w"> </span><span class="n">cp</span><span class="p">]</span><span class="w">
                                      </span><span class="n">*command-line-args*</span><span class="p">))</span><span class="w">
           </span><span class="p">(</span><span class="nf">.redirectOutput</span><span class="w"> </span><span class="n">ProcessBuilder$Redirect/INHERIT</span><span class="p">))</span><span class="w">
      </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nf">.start</span><span class="w"> </span><span class="n">pb</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">wait/wait-for-port</span><span class="w"> </span><span class="s">"localhost"</span><span class="w"> </span><span class="n">nrepl-port</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="s">".nrepl-port"</span><span class="w"> </span><span class="n">nrepl-port</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">.deleteOnExit</span><span class="w"> </span><span class="p">(</span><span class="nf">File.</span><span class="w"> </span><span class="s">".nrepl-port"</span><span class="p">))</span><span class="w">
  </span><span class="p">(</span><span class="nf">.waitFor</span><span class="w"> </span><span class="n">proc</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_debugging_the_nrepl_server">Debugging the nREPL server</h5>
<div class="paragraph">
<p>To debug the nREPL server from the binary you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ BABASHKA_DEV</span><span class="o">=</span><span class="nb">true </span>bb <span class="nt">--nrepl-server</span> 1667</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will print all the incoming messages.</p>
</div>
<div class="paragraph">
<p>To debug the nREPL server from source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="no">://github.com/borkdude/babashka</span><span class="w"> </span><span class="n">--recurse-submodules</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">babashka</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">BABASHKA_DEV=true</span><span class="w"> </span><span class="n">clojure</span><span class="w"> </span><span class="n">-A</span><span class="no">:main</span><span class="w"> </span><span class="n">--nrepl-server</span><span class="w"> </span><span class="mi">1667</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_preloads">Preloads</h3>
<div class="paragraph">
<p>The environment variable <code>BABASHKA_PRELOADS</code> allows to define code that
will be available in all subsequent usages of babashka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">BABASHKA_PRELOADS</span><span class="o">=</span><span class="s1">'(defn foo [x] (+ x 2))'</span>
<span class="nv">BABASHKA_PRELOADS</span><span class="o">=</span><span class="nv">$BABASHKA_PRELOADS</span><span class="s1">' (defn bar [x] (* x 2))'</span>
<span class="nb">export </span>BABASHKA_PRELOADS</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you can concatenate multiple expressions. Now you can use
these functions in babashka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bb <span class="s1">'(-&gt; (foo *input*) bar)'</span> <span class="o">&lt;&lt;&lt;</span> 1
6</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also preload an entire file using <code>load-file</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">BABASHKA_PRELOADS</span><span class="o">=</span><span class="s1">'(load-file "my_awesome_prelude.clj")'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>*input*</code> is not available in preloads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_classpath">Classpath</h3>
<div class="paragraph">
<p>Babashka accepts a <code>--classpath</code> option that will be used to search for
namespaces when requiring them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">src/my/namespace.clj</span><span class="w">
</span><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">my.namespace</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-main</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="w"> </span><span class="n">_args</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Hello from my namespace!"</span><span class="p">))</span><span class="w">

</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">--classpath</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="n">--main</span><span class="w"> </span><span class="n">my.namespace</span><span class="w">
</span><span class="n">Hello</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">namespace!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a larger script with a classic Clojure project layout like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>tree <span class="nt">-L</span> 3
├── deps.edn
├── README
├── src
│   └── project_namespace
│       ├── main.clj
│       └── utilities.clj
└── <span class="nb">test</span>
    └── project_namespace
        ├── test_main.clj
        └── test_utilities.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you can tell babashka to include both the <code>src</code> and <code>test</code> folders
in the classpath and start a socket REPL by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bb <span class="nt">--classpath</span> src:test <span class="nt">--socket-repl</span> 1666</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you can use the <code>clojure</code> tool to produce classpaths and
download dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat </span>deps.edn
<span class="o">{</span>:deps
 <span class="o">{</span>my_gist_script
  <span class="o">{</span>:git/url <span class="s2">"https://gist.github.com/borkdude/263b150607f3ce03630e114611a4ef42"</span>
   :sha <span class="s2">"cfc761d06dfb30bb77166b45d439fe8fe54a31b8"</span><span class="o">}}</span>
 :aliases <span class="o">{</span>:my-script <span class="o">{</span>:main-opts <span class="o">[</span><span class="s2">"-m"</span> <span class="s2">"my-gist-script"</span><span class="o">]}}}</span>

<span class="nv">$ CLASSPATH</span><span class="o">=</span><span class="si">$(</span>clojure <span class="nt">-Spath</span><span class="si">)</span>
<span class="nv">$ </span>bb <span class="nt">--classpath</span> <span class="s2">"</span><span class="nv">$CLASSPATH</span><span class="s2">"</span> <span class="nt">--main</span> my-gist-script
Hello from gist script!</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is no <code>--classpath</code> argument, the <code>BABASHKA_CLASSPATH</code>
environment variable will be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">BABASHKA_CLASSPATH</span><span class="o">=</span><span class="si">$(</span>clojure <span class="nt">-Spath</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">BABASHKA_PRELOADS</span><span class="o">=</span><span class="s2">"(require '[my-gist-script])"</span>
<span class="nv">$ </span>bb <span class="s2">"(my-gist-script/-main)"</span>
Hello from gist script!</code></pre>
</div>
</div>
<div class="paragraph">
<p>When invoking <code>bb</code> with a main function, the expression
<code>(System/getProperty "babashka.main")</code> will return the name of the main
function.</p>
</div>
<div class="paragraph">
<p>Also see the <a href="#babashka_classpath">babashka.classpath</a>
namespace which allows dynamically adding to the classpath.</p>
</div>
<div class="paragraph">
<p>See <a href="#deps_clj">deps.clj</a> for a babashka script that replaces the <code>clojure</code>
bash script.</p>
</div>
</div>
<div class="sect2">
<h3 id="_uberscript">Uberscript</h3>
<div class="paragraph">
<p>The <code>--uberscript</code> option collects the expressions in
<code>BABASHKA_PRELOADS</code>, the command line expression or file, the main
entrypoint and all required namespaces from the classpath into a single
file. This can be convenient for debugging and deployment.</p>
</div>
<div class="paragraph">
<p>Here is an example that uses a function from the
<a href="https://github.com/clj-commons/fs">clj-commons/fs</a> library.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first set the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">BABASHKA_CLASSPATH=$</span><span class="p">(</span><span class="nf">clojure</span><span class="w"> </span><span class="n">-Spath</span><span class="w"> </span><span class="n">-Sdeps</span><span class="w"> </span><span class="o">'</span><span class="p">{</span><span class="no">:deps</span><span class="w"> </span><span class="p">{</span><span class="n">clj-commons/fs</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"1.5.2"</span><span class="p">}}}</span><span class="o">'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a little script, say <code>glob.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">me.raynes.fs</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">fs</span><span class="p">]))</span><span class="w">
</span><span class="p">(</span><span class="nf">run!</span><span class="w"> </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="nb">println</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">fs/glob</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="n">*command-line-args*</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can execute the script which uses the library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">time </span>bb glob.clj <span class="s1">'*.md'</span>
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob.clj <span class="s1">'*.md'</span>   0.03s  user 0.02s system 70% cpu 0.064 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Producing an uberscript with all required code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bb <span class="nt">-f</span> glob.clj <span class="nt">--uberscript</span> glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>To prove that we don&#8217;t need the classpath anymore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">unset </span>BABASHKA_CLASSPATH
<span class="nv">$ </span><span class="nb">time </span>bb glob-uberscript.clj <span class="s1">'*.md'</span>
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj <span class="s1">'*.md'</span>   0.03s  user 0.02s system 93% cpu 0.049 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Dynamic requires</em>. Building uberscripts works by running top-level
<code>ns</code> and <code>require</code> forms. The rest of the code is not evaluated. Code
that relies on dynamic requires may not work in an uberscript.</p>
</li>
<li>
<p><em>Resources</em>. The usage of <code>io/resource</code> assumes a classpath, so when
this is used in your uberscript, you still have to set a classpath and
bring the resources along.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of the above is problematic for your project, using an
<a href="#uberjar">uberjar</a> is a good alternative.</p>
</div>
<div class="sect3">
<h4 id="_carve">Carve</h4>
<div class="paragraph">
<p>Uberscripts can be optimized by cutting out unused vars with
<a href="https://github.com/borkdude/carve">carve</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">wc</span> <span class="nt">-l</span> glob-uberscript.clj
     607 glob-uberscript.clj
<span class="nv">$ </span>clojure <span class="nt">-M</span>:carve <span class="nt">--opts</span> <span class="s1">'{:paths ["glob-uberscript.clj"] :aggressive true :silent true}'</span>
<span class="nv">$ </span><span class="nb">wc</span> <span class="nt">-l</span> glob-uberscript.clj
     172 glob-uberscript.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the uberscript became 72% shorter. This has a beneficial
effect on execution time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">time </span>bb glob-uberscript.clj <span class="s1">'*.md'</span>
/Users/borkdude/Dropbox/dev/clojure/carve/README.md
bb glob-uberscript.clj <span class="s1">'*.md'</span>   0.02s  user 0.01s system 93% cpu 0.032 total</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_uberjar">Uberjar</h3>
<div class="paragraph">
<p>Babashka can create uberjars from a given classpath and optionally a
main method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">src/foo.clj</span><span class="w">
</span><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span><span class="no">:gen-class</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-main</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">prn</span><span class="w"> </span><span class="no">:hello</span><span class="p">))</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-cp</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="nf">clojure</span><span class="w"> </span><span class="n">-Spath</span><span class="p">)</span><span class="w"> </span><span class="n">-m</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="n">--uberjar</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="no">:hello</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When producing a classpath using the <code>clojure</code> or <code>deps.clj</code> tool,
Clojure itself, spec and the core specs will be on the classpath and
will therefore be included in your uberjar, which makes it bigger than
necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lh</span> foo.jar
<span class="nt">-rw-r--r--</span>  1 borkdude  staff   4.5M Aug 19 17:04 foo.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>To exclude these dependencies, you can use the following
<code>:classpath-overrides</code> in your <code>deps.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">{</span><span class="no">:aliases</span><span class="w"> </span><span class="p">{</span><span class="no">:remove-clojure</span><span class="w"> </span><span class="p">{</span><span class="no">:classpath-overrides</span><span class="w"> </span><span class="p">{</span><span class="n">org.clojure/clojure</span><span class="w"> </span><span class="n">nil</span><span class="w">
                                                  </span><span class="n">org.clojure/spec.alpha</span><span class="w"> </span><span class="n">nil</span><span class="w">
                                                  </span><span class="n">org.clojure/core.specs.alpha</span><span class="w"> </span><span class="n">nil</span><span class="p">}}}}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-cp</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="nf">clojure</span><span class="w"> </span><span class="n">-A</span><span class="no">:remove-clojure</span><span class="w"> </span><span class="n">-Spath</span><span class="p">)</span><span class="w"> </span><span class="n">-m</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="n">--uberjar</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="no">:hello</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="n">-lh</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">-rw-r--r--</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="n">borkdude</span><span class="w">  </span><span class="n">staff</span><span class="w">   </span><span class="mi">871</span><span class="n">B</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">17</span><span class="no">:07</span><span class="w"> </span><span class="n">foo.jar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want your uberjar to be compatible with the JVM, you&#8217;ll need to
compile the main namespace. Babashka does not do compilation, so we use
Clojure on the JVM for that part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="n">classes</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">clojure</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="s">"(require 'foo) (compile 'foo)"</span><span class="w">
</span><span class="n">foo</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-cp</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="nf">clojure</span><span class="w"> </span><span class="n">-Spath</span><span class="p">)</span><span class="no">:classes</span><span class="w"> </span><span class="n">-m</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="n">--uberjar</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="no">:hello</span><span class="w">
</span><span class="n">$</span><span class="w"> </span><span class="n">java</span><span class="w"> </span><span class="n">-jar</span><span class="w"> </span><span class="n">foo.jar</span><span class="w">
</span><span class="no">:hello</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_system_properties">System properties</h3>
<div class="paragraph">
<p>Babashka sets the following system properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>babashka.version</code>: the version string, e.g. <code>"1.2.0"</code></p>
</li>
<li>
<p><code>babashka.main</code>: the <code>--main</code> argument</p>
</li>
<li>
<p><code>babashka.file</code>: the <code>--file</code> argument (normalized using
<code>.getAbsolutePath</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_data_readers">Data readers</h3>
<div class="paragraph">
<p>Data readers can be enabled by setting <code>*data-readers*</code> to a hashmap of
symbols to functions or vars:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="s">"(set! *data-readers* {'t/tag inc}) #t/tag 1"</span><span class="w">
</span><span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To preserve good startup time, babashka does not scan the classpath for
<code>data_readers.clj</code> files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parsing_command_line_arguments">Parsing command line arguments</h3>
<div class="paragraph">
<p>Babashka ships with <code>clojure.tools.cli</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.tools.cli</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">parse-opts</span><span class="p">]])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">cli-options</span><span class="w">
  </span><span class="c1">;; An option with a required argument</span><span class="w">
  </span><span class="p">[[</span><span class="s">"-p"</span><span class="w"> </span><span class="s">"--port PORT"</span><span class="w"> </span><span class="s">"Port number"</span><span class="w">
    </span><span class="no">:default</span><span class="w"> </span><span class="mi">80</span><span class="w">
    </span><span class="no">:parse-fn</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w">
    </span><span class="no">:validate</span><span class="w"> </span><span class="p">[</span><span class="o">#</span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">%</span><span class="w"> </span><span class="mi">0</span><span class="n">x10000</span><span class="p">)</span><span class="w"> </span><span class="s">"Must be a number between 0 and 65536"</span><span class="p">]]</span><span class="w">
   </span><span class="p">[</span><span class="s">"-h"</span><span class="w"> </span><span class="s">"--help"</span><span class="p">]])</span><span class="w">

</span><span class="p">(</span><span class="no">:options</span><span class="w"> </span><span class="p">(</span><span class="nf">parse-opts</span><span class="w"> </span><span class="n">*command-line-args*</span><span class="w"> </span><span class="n">cli-options</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bb script.clj
<span class="o">{</span>:port 80<span class="o">}</span>
<span class="nv">$ </span>bb script.clj <span class="nt">-h</span>
<span class="o">{</span>:port 80, :help <span class="nb">true</span><span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reader_conditionals">Reader conditionals</h3>
<div class="paragraph">
<p>Babashka supports reader conditionals by taking either the <code>:bb</code> or
<code>:clj</code> branch, whichever comes first. NOTE: the <code>:clj</code> branch behavior
was added in version 0.0.71, before that version the <code>:clj</code> branch was
ignored.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="s">"#?(:bb :hello :clj :bye)"</span><span class="w">
</span><span class="no">:hello</span><span class="w">

</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="s">"#?(:clj :bye :bb :hello)"</span><span class="w">
</span><span class="no">:bye</span><span class="w">

</span><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="s">"[1 2 #?@(:bb [] :clj [1])]"</span><span class="w">
</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="style">Style</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A note on style. Babashka recommends the following:</p>
</div>
<div class="sect2">
<h3 id="_explicit_requires">Explicit requires</h3>
<div class="paragraph">
<p>Use explicit requires with namespace aliases in scripts, unless you&#8217;re
writing one-liners.</p>
</div>
<div class="paragraph">
<p>Do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">ls</span> | bb <span class="nt">-i</span> <span class="s1">'(-&gt; *input* first (str/includes? "m"))'</span>
<span class="nb">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But not this:</p>
</div>
<div class="paragraph">
<p>script.clj:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">*input*</span><span class="w"> </span><span class="nb">first</span><span class="w"> </span><span class="p">(</span><span class="nf">str/includes?</span><span class="w"> </span><span class="s">"m"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rather do this:</p>
</div>
<div class="paragraph">
<p>script.clj:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">script</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.string</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="nb">str</span><span class="p">]))</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">*in*</span><span class="p">)</span><span class="w"> </span><span class="nb">line-seq</span><span class="w"> </span><span class="nb">first</span><span class="w"> </span><span class="p">(</span><span class="nf">str/includes?</span><span class="w"> </span><span class="s">"m"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some reasons for this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linters like clj-kondo work better with code that uses namespace
forms, explicit requires, and known Clojure constructs</p>
</li>
<li>
<p>Editor tooling works better with namespace forms (sorting requires,
etc).</p>
</li>
<li>
<p>Writing compatible code gives you the option to run the same script
with <code>clojure</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="libraries">Libraries</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_built_in_namespaces">Built-in namespaces</h3>
<div class="paragraph">
<p>In addition to <code>clojure.core</code>, the following namespaces are available in babashka.
Some are available through pre-defined aliases in the <code>user</code> namespace,
which can be handy for one-liners. If not all vars are available, they
are enumerated explicitly. If some important var is missing, an issue or
PR is welcome.</p>
</div>
<div class="paragraph">
<p>From Clojure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clojure.core</code></p>
</li>
<li>
<p><code>clojure.core.protocols</code>: <code>Datafiable</code>, <code>Navigable</code></p>
</li>
<li>
<p><code>clojure.data</code></p>
</li>
<li>
<p><code>clojure.datafy</code></p>
</li>
<li>
<p><code>clojure.edn</code> aliased as <code>edn</code></p>
</li>
<li>
<p><code>clojure.java.browse</code></p>
</li>
<li>
<p><code>clojure.java.io</code> aliased as <code>io</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>as-relative-path</code>, <code>as-url</code>, <code>copy</code>, <code>delete-file</code>, <code>file</code>,
<code>input-stream</code>, <code>make-parents</code>, <code>output-stream</code>, <code>reader</code>, <code>resource</code>,
<code>writer</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>clojure.java.shell</code> aliased as <code>shell</code></p>
</li>
<li>
<p><code>clojure.main</code>: <code>demunge</code>, <code>repl</code>, <code>repl-requires</code></p>
</li>
<li>
<p><code>clojure.pprint</code>: <code>pprint</code>, <code>cl-format</code></p>
</li>
<li>
<p><code>clojure.set</code> aliased as <code>set</code></p>
</li>
<li>
<p><code>clojure.string</code> aliased as <code>str</code></p>
</li>
<li>
<p><code>clojure.stacktrace</code></p>
</li>
<li>
<p><code>clojure.test</code></p>
</li>
<li>
<p><code>clojure.zip</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional libraries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/borkdude/babashka.curl"><code>babashka.curl</code></a></p>
</li>
<li>
<p><a href="https://github.com/babashka/process"><code>babashka/process</code></a></p>
</li>
<li>
<p><a href="https://github.com/nrepl/bencode"><code>bencode.core</code></a> aliased as <code>bencode</code>:
<code>read-bencode</code>, <code>write-bencode</code></p>
</li>
<li>
<p><a href="https://github.com/dakrone/cheshire"><code>cheshire.core</code></a> aliased as <code>json</code></p>
</li>
<li>
<p><a href="https://clojure.github.io/core.async/"><code>clojure.core.async</code></a> aliased as
<code>async</code>. Also see <a href="https://github.com/borkdude/babashka#coreasync">docs</a>.</p>
</li>
<li>
<p><a href="https://github.com/clojure/data.csv"><code>clojure.data.csv</code></a> aliased as
<code>csv</code></p>
</li>
<li>
<p><a href="https://github.com/clojure/data.xml"><code>clojure.data.xml</code></a> aliased as
<code>xml</code></p>
</li>
<li>
<p><a href="https://github.com/clojure/tools.cli"><code>clojure.tools.cli</code></a> aliased as
<code>tools.cli</code></p>
</li>
<li>
<p><a href="https://github.com/clj-commons/clj-yaml"><code>clj-yaml.core</code></a> alias as
<code>yaml</code></p>
</li>
<li>
<p><a href="https://github.com/cognitect/transit-clj"><code>cognitect.transit</code></a> aliased
as <code>transit</code></p>
</li>
<li>
<p><a href="https://github.com/http-kit/http-kit"><code>org.httpkit.client</code></a></p>
</li>
<li>
<p><a href="https://github.com/http-kit/http-kit"><code>org.httpkit.server</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the
<a href="https://github.com/borkdude/babashka/blob/master/doc/projects.md">projects</a>
page for libraries that are not built-in, but which you can load from
source via the <code>--classpath</code> option.</p>
</div>
<div class="paragraph">
<p>See the
<a href="https://github.com/borkdude/babashka/blob/master/doc/build.md">build</a>
page for built-in libraries that can be enabled via feature flags, if
you want to compile babashka yourself.</p>
</div>
<div class="paragraph">
<p>A selection of Java classes are available, see
<code>babashka/impl/classes.clj</code> in babashka&#8217;s git repo.</p>
</div>
</div>
<div class="sect2">
<h3 id="_babashka_namespaces">Babashka namespaces</h3>
<div class="sect3">
<h4 id="babashka_classpath">babashka.classpath</h4>
<div class="paragraph">
<p>Contains the function <code>add-classpath</code> which can be used to add to the
classpath dynamically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">babashka.classpath</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">add-classpath</span><span class="p">]]</span><span class="w">
         </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.java.shell</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">sh</span><span class="p">]]</span><span class="w">
         </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.string</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="nb">str</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">medley-dep</span><span class="w"> </span><span class="o">'</span><span class="p">{</span><span class="no">:deps</span><span class="w"> </span><span class="p">{</span><span class="n">medley</span><span class="w"> </span><span class="p">{</span><span class="no">:git/url</span><span class="w"> </span><span class="s">"https://github.com/borkdude/medley"</span><span class="w">
                                 </span><span class="no">:sha</span><span class="w"> </span><span class="s">"91adfb5da33f8d23f75f0894da1defe567a625c0"</span><span class="p">}}})</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">sh</span><span class="w"> </span><span class="s">"clojure"</span><span class="w"> </span><span class="s">"-Spath"</span><span class="w"> </span><span class="s">"-Sdeps"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">medley-dep</span><span class="p">))</span><span class="w"> </span><span class="no">:out</span><span class="w"> </span><span class="n">str/trim</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">add-classpath</span><span class="w"> </span><span class="n">cp</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">medley.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">m</span><span class="p">])</span><span class="w">
</span><span class="p">(</span><span class="nf">m/index-by</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="p">}])</span><span class="w"> </span><span class="c1">;;=&gt; {1 {:id 1}, 2 {:id 2}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="babashkawait">babashka.wait</h4>
<div class="paragraph">
<p>Contains the functions: <code>wait-for-port</code> and <code>wait-for-path</code>.</p>
</div>
<div class="paragraph">
<p>Usage of <code>wait-for-port</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">wait/wait-for-port</span><span class="w"> </span><span class="s">"localhost"</span><span class="w"> </span><span class="mi">8080</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">wait/wait-for-port</span><span class="w"> </span><span class="s">"localhost"</span><span class="w"> </span><span class="mi">8080</span><span class="w"> </span><span class="p">{</span><span class="no">:timeout</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="no">:pause</span><span class="w"> </span><span class="mi">1000</span><span class="p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Waits for TCP connection to be available on host and port. Options map
supports <code>:timeout</code> and <code>:pause</code>. If <code>:timeout</code> is provided and reached,
<code>:default</code>'s value (if any) is returned. The <code>:pause</code> option determines
the time waited between retries.</p>
</div>
<div class="paragraph">
<p>Usage of <code>wait-for-path</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">wait/wait-for-path</span><span class="w"> </span><span class="s">"/tmp/wait-path-test"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">wait/wait-for-path</span><span class="w"> </span><span class="s">"/tmp/wait-path-test"</span><span class="w"> </span><span class="p">{</span><span class="no">:timeout</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="no">:pause</span><span class="w"> </span><span class="mi">1000</span><span class="p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Waits for file path to be available. Options map supports <code>:default</code>,
<code>:timeout</code> and <code>:pause</code>. If <code>:timeout</code> is provided and reached,
<code>:default</code>'s value (if any) is returned. The <code>:pause</code> option determines
the time waited between retries.</p>
</div>
<div class="paragraph">
<p>The namespace <code>babashka.wait</code> is aliased as <code>wait</code> in the <code>user</code>
namespace.</p>
</div>
</div>
<div class="sect3">
<h4 id="babashkasignal">babashka.signal</h4>
<div class="paragraph">
<p>Contains the function <code>signal/pipe-signal-received?</code>. Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">signal/pipe-signal-received?</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Returns true if <code>PIPE</code> signal was received. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bb <span class="s1">'((fn [x] (println x) (when (not (signal/pipe-signal-received?)) (recur (inc x)))) 0)'</span> | <span class="nb">head</span> <span class="nt">-n2</span>
1
2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The namespace <code>babashka.signal</code> is aliased as <code>signal</code> in the <code>user</code>
namespace.</p>
</div>
</div>
<div class="sect3">
<h4 id="babashkacurl">babashka.curl</h4>
<div class="paragraph">
<p>The namespace <code>babashka.curl</code> is a tiny wrapper around curl. It&#8217;s aliased as
<code>curl</code> in the user namespace. See
<a href="https://github.com/borkdude/babashka.curl">babashka.curl</a> for how to use it.</p>
</div>
</div>
<div class="sect3">
<h4 id="babashkaprocess">babashka.process</h4>
<div class="paragraph">
<p>The <code>babashka.process</code> process library. See the
<a href="https://github.com/babashka/process">process</a> repo for API docs.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="child_processes">Child processes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>by Michiel Borkent</p>
</div>
<div class="paragraph">
<p>There are several ways of creating child processes in babashka. Let&#8217;s start with
the easiest one.</p>
</div>
<div class="sect2">
<h3 id="_clojure_java_shell">clojure.java.shell</h3>
<div class="paragraph">
<p>A common way to shell out to another process is via <code>clojure.java.shell</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.java.shell</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">sh</span><span class="p">]])</span><span class="w">
</span><span class="n">nil</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">sh</span><span class="w"> </span><span class="s">"ls"</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:exit</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:out</span><span class="w"> </span><span class="s">"README.md\ndist\ngh-pages\nscript\nsrc\n"</span><span class="n">,</span><span class="w"> </span><span class="no">:err</span><span class="w"> </span><span class="s">""</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the result of <code>:out</code> are the lines of text produced by <code>ls</code>. The
<code>:exit</code> code was <code>0</code> and there was no output on stderr.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">sh</span><span class="w"> </span><span class="s">"ls"</span><span class="w"> </span><span class="s">"foo"</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:exit</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:out</span><span class="w"> </span><span class="s">""</span><span class="n">,</span><span class="w"> </span><span class="no">:err</span><span class="w"> </span><span class="s">"ls: foo: No such file or directory\n"</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we invoke <code>ls</code> with a non-existing file, there is error output, but not
output on stdout and the <code>:exit</code> code is <code>1</code>.</p>
</div>
<div class="paragraph">
<p>For more information on <code>clojure.java.shell</code>, read the
<a href="https://clojure.github.io/clojure/clojure.java.shell-api.html">API documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_babashka_process">babashka.process</h3>
<div class="paragraph">
<p>Creating a child process with <code>clojure.java.shell/sh</code> is convenient and
sufficient in 90% of the scripts you&#8217;re going to write with babashka. For the
remaining 10% you&#8217;re going to need something slightly more powerful. This is
where the <code>babashka.process</code> library namespace comes in. The README and source
code of this library is located <a href="https://github.com/babashka/process">here</a>.</p>
</div>
<div class="paragraph">
<p>What if we wanted to start a Clojure pREPL in our script, send commands to it
and read the evaluated output in a loop?  Using <code>clojure.java.shell/sh</code> for this
has the limitation that we can only send input and read output once per process.
Using <code>babashka.process</code> which leverages the <code>java.lang.ProcessBuilder</code> and
<code>java.lang.Process</code> classes gives us the extra power we need to overcome this
limitation.</p>
</div>
<div class="paragraph">
<p>First we show how to use <code>process</code> to start a process that inherits stdout,
stderr and stdin from the parent process. This is often useful when you want to
hand over control to another process at the end of a script. The following code
starts a pREPL process:</p>
</div>
<div class="listingblock">
<div class="title">process/prepl_1.clj</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="o">#</span><span class="n">!/usr/bin/env</span><span class="w"> </span><span class="n">bb</span><span class="w">

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">babashka.process</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">p</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">io-prepl</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">cmd</span><span class="w"> </span><span class="p">[</span><span class="s">"clojure"</span><span class="w"> </span><span class="s">"-M"</span><span class="w">
             </span><span class="s">"-e"</span><span class="w"> </span><span class="s">"(require '[clojure.core.server :as s])"</span><span class="w">
             </span><span class="s">"-e"</span><span class="w"> </span><span class="s">"(s/io-prepl)"</span><span class="p">]</span><span class="w">                           <i class="conum" data-value="1"></i><b>(1)</b>
        </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nf">p/process</span><span class="w"> </span><span class="n">cmd</span><span class="w">                                 <i class="conum" data-value="2"></i><b>(2)</b>
                        </span><span class="p">{</span><span class="no">:inherit</span><span class="w"> </span><span class="n">true</span><span class="w">                      <i class="conum" data-value="3"></i><b>(3)</b>
                         </span><span class="no">:shutdown</span><span class="w"> </span><span class="n">p/destroy-tree</span><span class="p">})]</span><span class="w">        <i class="conum" data-value="4"></i><b>(4)</b>
    </span><span class="n">proc</span><span class="p">))</span><span class="w">

</span><span class="o">@</span><span class="p">(</span><span class="nf">io-prepl</span><span class="p">)</span><span class="w">                                                 <i class="conum" data-value="5"></i><b>(5)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command and its arguments</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creating the process</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This option redirects stdout and stdin from the parent process to the child
process.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This line will destroy the child process and all of it&#8217;s children processes
before the parent process exits.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dereferencing the process waits until it ends. If
we would not include this, our script would end immediately.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When calling the script, we can interact with the pREPL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb src/process/prepl_1.clj
<span class="o">(</span>+ 1 2 3<span class="o">)</span>
<span class="o">{</span>:tag :ret, :val <span class="s2">"6"</span>, :ns <span class="s2">"user"</span>, :ms 5, :form <span class="s2">"(+ 1 2 3)"</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pressing ctrl-C or typing <code>:repl/quit</code> will make the script terminate.</p>
</div>
<div class="paragraph">
<p>What if we want to parse the output of the prepl and reformat it to our own
likings?  Instead of sending the output of the child process to stdout we will
have to get a hold of it. We can grab the output by not using <code>:inherit</code> and
getting the <code>:out</code> stream of the process. Similarly we will grab the <code>:in</code>
stream of the process and handle reading ourselves.</p>
</div>
<div class="listingblock">
<div class="title">process/prepl_2.clj</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="o">#</span><span class="n">!/usr/bin/env</span><span class="w"> </span><span class="n">bb</span><span class="w">

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">babashka.process</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">p</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">io-prepl</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">cmd</span><span class="w"> </span><span class="p">[</span><span class="s">"clojure"</span><span class="w"> </span><span class="s">"-M"</span><span class="w">
             </span><span class="s">"-e"</span><span class="w"> </span><span class="s">"(require '[clojure.core.server :as s])"</span><span class="w">
             </span><span class="s">"-e"</span><span class="w"> </span><span class="s">"(s/io-prepl)"</span><span class="p">]</span><span class="w">
        </span><span class="n">proc</span><span class="w"> </span><span class="p">(</span><span class="nf">p/process</span><span class="w"> </span><span class="n">cmd</span><span class="w">
                        </span><span class="p">{</span><span class="no">:shutdown</span><span class="w"> </span><span class="n">p/destroy-tree</span><span class="p">})]</span><span class="w">
    </span><span class="n">proc</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">prepl-process</span><span class="w"> </span><span class="p">(</span><span class="nf">io-prepl</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">input-writer</span><span class="w"> </span><span class="p">(</span><span class="nf">io/writer</span><span class="w"> </span><span class="p">(</span><span class="no">:in</span><span class="w"> </span><span class="n">prepl-process</span><span class="p">)))</span><span class="w">        <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">output-reader</span><span class="w"> </span><span class="p">(</span><span class="nf">java.io.PushbackReader.</span><span class="w">
                    </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="p">(</span><span class="no">:out</span><span class="w"> </span><span class="n">prepl-process</span><span class="p">))))</span><span class="w">    <i class="conum" data-value="2"></i><b>(2)</b>

</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.edn</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">edn</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Type an expression to evaluate:"</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nb">when-let</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="nb">read-line</span><span class="p">)]</span><span class="w">                               <i class="conum" data-value="3"></i><b>(3)</b>
    </span><span class="p">(</span><span class="nb">binding</span><span class="w"> </span><span class="p">[</span><span class="n">*out*</span><span class="w"> </span><span class="n">input-writer</span><span class="p">]</span><span class="w">                         <i class="conum" data-value="4"></i><b>(4)</b>
      </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">v</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">next-val</span><span class="w"> </span><span class="p">(</span><span class="nf">edn/read</span><span class="w"> </span><span class="p">{</span><span class="no">:eof</span><span class="w"> </span><span class="no">::EOF</span><span class="p">}</span><span class="w"> </span><span class="n">output-reader</span><span class="p">)]</span><span class="w"> <i class="conum" data-value="5"></i><b>(5)</b>
      </span><span class="p">(</span><span class="nb">when-not</span><span class="w"> </span><span class="p">(</span><span class="nb">identical?</span><span class="w"> </span><span class="no">::EOF</span><span class="w"> </span><span class="n">next-val</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="no">:form</span><span class="w"> </span><span class="n">next-val</span><span class="p">)</span><span class="w">                         <i class="conum" data-value="6"></i><b>(6)</b>
                 </span><span class="s">"evaluates to"</span><span class="w">
                 </span><span class="p">(</span><span class="no">:val</span><span class="w"> </span><span class="n">next-val</span><span class="p">))</span><span class="w">
        </span><span class="p">(</span><span class="nf">recur</span><span class="p">)))))</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A writer that we will use to send input to the pREPL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A reader that reads from the pREPL output. pREPL returns EDN and
<code>clojure.edn/read</code> needs a <code>PushbackReader</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We read user input via <code>clojure.core/read-line</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here we binding <code>*out*</code> to the input writer so we can use <code>println</code> to write
to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Read the next EDN value.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Print the output using our custom formatting.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb src/process/prepl_2.clj
Type an expression to evaluate:
<span class="o">(</span>+ 1 2 3<span class="o">)</span>
<span class="o">(</span>+ 1 2 3<span class="o">)</span> evaluates to 6
:repl/quit</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_real_world_examples">Real world examples</h4>
<div class="paragraph">
<p>Prior to <code>babashka.process</code> people were using raw <code>ProcessBuilder</code> interop. Here are some real world examples. These might get updated to <code>babashka.process</code> in the future.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/borkdude/babashka/blob/5608f935cd28c777cf7d16243574558e2203872e/script/bump_version.clj#L9">babashka</a> repo uses <code>ProcessBuilder</code> to invoke git to make a commit after bumping the version.
It redirects the output from <code>git</code> directly to stdout of the parent process.</p>
</li>
<li>
<p><a href="https://github.com/borkdude/babashka.curl/blob/53b5b9d98f2e594384f628b0deee76b53bea5062/src/babashka/curl.clj#L17">babashka.curl</a> uses <code>ProcessBuilder</code> to interact with the <code>curl</code> executable</p>
</li>
<li>
<p><a href="https://github.com/borkdude/deps.clj/blob/5d51b80176bdcb96927ce5e6aedb25581db0e2e0/deps.clj#L18">deps.clj</a>
uses <code>ProcessBuilder</code> to interact with <code>java</code>, e.g. to start a Clojure REPL or
compute a classpath using tools.deps</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deps_clj">Deps.clj</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/borkdude/deps.clj/"><code>deps.clj</code></a> script can be used
to work with <code>deps.edn</code>-based projects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>deps.clj <span class="nt">-A</span>:my-script <span class="nt">-Scommand</span> <span class="s2">"bb -cp {{classpath}} {{main-opts}}"</span>
Hello from gist script!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create these aliases for brevity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">alias </span>bb-deps<span class="o">=</span><span class="s1">'deps.clj -Scommand "bb -cp {{classpath}} {{main-opts}}"'</span>
<span class="nv">$ </span><span class="nb">alias </span>bb-deps-repl<span class="o">=</span><span class="s1">'rlwrap deps.clj -Scommand "bb -cp {{classpath}} {{main-opts}}"'</span>
<span class="nv">$ </span>bb-deps <span class="nt">-M</span>:my-script
Hello from gist script!
<span class="nv">$ </span>bb-deps-repl
Babashka v0.0.58 REPL.
Use :repl/quit or :repl/exit to quit the REPL.
Clojure rocks, Bash reaches.

<span class="nv">user</span><span class="o">=&gt;</span> <span class="o">(</span>require <span class="s1">'[my-gist-script :as mgs])
nil
user=&gt; (mgs/-main)
Hello from gist script!
nil</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use for example <code>deps.clj</code> to produce the classpath for a
<code>babashka</code> REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shellsession">$ cat script/start-repl.sh
#!/bin/sh -e
git_root=$(git rev-parse --show-toplevel)
export BABASHKA_CLASSPATH=$("$git_root"/script/deps.clj -Spath)
bb --socket-repl 1666
$ ./script/start-repl.sh
Babashka socket REPL started at localhost:1666</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, given that your <code>deps.edn</code> and source tree looks something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shellsession">$ cat deps.edn
{:paths ["src" "test"]
 :deps  {}}
$ tree -L 3
├── deps.edn
├── README
├── script
│   ├── deps.clj
│   └── start-repl.sh
├── src
│   └── project_namespace
│       ├── main.clj
│       └── utilities.clj
└── test
    └── project_namespace
        ├── test_main.clj
        └── test_utilities.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>you should now be able to
<code>(require '[multi-machine-rsync.utilities :as util])</code> in your REPL and
the source code in <code>/src/multi_machine_rsync/utilities.clj</code> will be
evaluated and made available through the symbol <code>util</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="recipes">Recipes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_running_tests">Running tests</h3>
<div class="paragraph">
<p>Babashka bundles <code>clojure.test</code>. To make CI scripts fail you can use a
simple runner like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c">#!/usr/bin/env bash</span>
bb <span class="nt">-cp</span> <span class="s2">"src:test:resources"</span> <span class="se">\</span>
   <span class="nt">-e</span> <span class="s2">"(require '[clojure.test :as t] '[borkdude.deps-test])
       (let [{:keys [:fail :error]} (t/run-tests 'borkdude.deps-test)]
         (System/exit (+ fail error)))"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="main_file">Main file</h3>
<div class="paragraph">
<p>In Python scripts there is a well-known pattern to check if the current
file was the file invoked from the command line, or loaded from another
file: the <code>__name__ == "__main__"</code> pattern. In babashka this pattern can
be implemented with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">*file*</span><span class="w"> </span><span class="p">(</span><span class="nf">System/getProperty</span><span class="w"> </span><span class="s">"babashka.file"</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shutdown_hook">Shutdown hook</h3>
<div class="paragraph">
<p>Adding a shutdown hook allows you to execute some code before the script
exits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">Runtime/getRuntime</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.addShutdownHook</span><span class="w"> </span><span class="p">(</span><span class="nf">Thread.</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"bye"</span><span class="p">))))</span><span class="o">'</span><span class="w">
</span><span class="n">bye</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This also works when the script is interrupted with ctrl-c.</p>
</div>
</div>
<div class="sect2">
<h3 id="_printing_returned_values">Printing returned values</h3>
<div class="paragraph">
<p>Babashka doesn&#8217;t print a returned <code>nil</code> as lots of scripts end in
something side-effecting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bb <span class="s1">'(:a {:a 5})'</span>
5
<span class="nv">$ </span>bb <span class="s1">'(:b {:a 5})'</span>
<span class="err">$</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you really want to print the nil, you can use <code>(prn ..)</code> instead.</p>
</div>
</div>
<div class="sect2">
<h3 id="_http_requests">HTTP requests</h3>
<div class="paragraph">
<p>For making HTTP requests you can use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/borkdude/babashka.curl">babashka.curl</a>. This library
is included with babashka and aliased as <code>curl</code> in the user namespace.
The interface is similar to that of
<a href="https://github.com/dakrone/clj-http">clj-http</a> but it will shell out to
<code>curl</code> to make requests.</p>
</li>
<li>
<p><a href="https://github.com/http-kit/http-kit">org.httpkit.client</a></p>
</li>
<li>
<p><code>slurp</code> for simple <code>GET</code> requests</p>
</li>
<li>
<p><a href="https://github.com/babashka/clj-http-lite">clj-http-lite</a> as a library.</p>
</li>
<li>
<p><code>clojure.java.shell</code> or <code>babashka.process</code> for shelling out to your
favorite command line http client</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_choosing_the_right_client">Choosing the right client</h4>
<div class="paragraph">
<p>If memory usage is a concern and you are downloading big files, choose
<code>babashka.curl</code> with <code>:as :stream</code> over <code>org.httpkit.client</code> since
http-kit holds the entire response in memory at once. Let&#8217;s download a
200mb file with 10mb heap size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-Xmx10m</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">io/copy</span><span class="w"> </span><span class="p">(</span><span class="no">:body</span><span class="w"> </span><span class="p">(</span><span class="nf">curl/get</span><span class="w"> </span><span class="s">"http://ipv4.download.thinkbroadband.com/200MB.zip"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="no">:stream</span><span class="p">}))</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"/tmp/200mb.zip"</span><span class="p">))</span><span class="o">'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>babashka.curl</code> this works fine. However with <code>org.httpkit.client</code>
that won&#8217;t work. Not even 190mb of heap will do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">$</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">-Xmx190m</span><span class="w"> </span><span class="n">-e</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">io/copy</span><span class="w"> </span><span class="p">(</span><span class="no">:body</span><span class="w"> </span><span class="o">@</span><span class="p">(</span><span class="nf">org.httpkit.client/get</span><span class="w"> </span><span class="s">"http://ipv4.download.thinkbroadband.com/200MB.zip"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="no">:stream</span><span class="p">}))</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"/tmp/200mb.zip"</span><span class="p">))</span><span class="o">'</span><span class="w">
</span><span class="n">Sun</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">23</span><span class="no">:01:46</span><span class="w"> </span><span class="n">CET</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="p">[</span><span class="n">client-loop</span><span class="p">]</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nb">select</span><span class="w"> </span><span class="n">exception,</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="nb">not</span><span class="w"> </span><span class="n">happen</span><span class="w">
</span><span class="n">java.lang.OutOfMemoryError</span><span class="err">:</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">large.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If your script creates many requests with relatively small payloads,
choose <code>org.httpkit.client</code> over <code>babashka.curl</code> since <code>babashka.curl</code>
creates a <code>curl</code> process for each request.</p>
</div>
<div class="paragraph">
<p>In the future babashka (1.0.0?) may come with an HTTP client based on
the JVM 11 <code>java.net.http</code> package that ticks all the boxes (async,
HTTP/2, websockets, multi-part file uploads, sane memory usage) and is a
suitable replacement for all of the above options. If you know about a
GraalVM-friendly feature-complete well-maintained library, please reach
out!</p>
</div>
</div>
<div class="sect3">
<h4 id="_http_over_unix_sockets">HTTP over Unix sockets</h4>
<div class="paragraph">
<p>This can be useful for talking to Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.java.shell</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">sh</span><span class="p">]])</span><span class="w">
</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">cheshire.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">json</span><span class="p">])</span><span class="w">
</span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">sh</span><span class="w"> </span><span class="s">"curl"</span><span class="w"> </span><span class="s">"--silent"</span><span class="w">
        </span><span class="s">"--no-buffer"</span><span class="w"> </span><span class="s">"--unix-socket"</span><span class="w">
        </span><span class="s">"/var/run/docker.sock"</span><span class="w">
        </span><span class="s">"http://localhost/images/json"</span><span class="p">)</span><span class="w">
    </span><span class="no">:out</span><span class="w">
    </span><span class="p">(</span><span class="nf">json/parse-string</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
    </span><span class="nb">first</span><span class="w">
    </span><span class="no">:RepoTags</span><span class="p">)</span><span class="w"> </span><span class="c1">;;=&gt; ["borkdude/babashka:latest"]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core_async">Core.async</h3>
<div class="paragraph">
<p>In addition to <code>future</code>, <code>pmap</code>, <code>promise</code> and friends, you may use the
<code>clojure.core.async</code> namespace for asynchronous scripting. The following
example shows how to get first available value from two different
processes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">bb</span><span class="w"> </span><span class="o">'</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">async-command</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">async/thread</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="n">shell/sh</span><span class="w"> </span><span class="s">"bash"</span><span class="w"> </span><span class="s">"-c"</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">async/alts!!</span><span class="w"> </span><span class="p">[(</span><span class="nf">async-command</span><span class="w"> </span><span class="s">"sleep 2 &amp;&amp; echo process 1"</span><span class="p">)</span><span class="w">
                   </span><span class="p">(</span><span class="nf">async-command</span><span class="w"> </span><span class="s">"sleep 1 &amp;&amp; echo process 2"</span><span class="p">)])</span><span class="w">
    </span><span class="nb">first</span><span class="w"> </span><span class="no">:out</span><span class="w"> </span><span class="n">str/trim</span><span class="w"> </span><span class="nb">println</span><span class="p">)</span><span class="o">'</span><span class="w">
</span><span class="n">process</span><span class="w"> </span><span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Caveat: currently the <code>go</code> macro is available for compatibility with JVM
programs, but the implementation maps to <code>clojure.core.async/thread</code> and
the single exclamation mark operations (<code>&lt;!</code>, <code>&gt;!</code>, etc.) map to the
double exclamation mark operations (<code>&lt;!!</code>, <code>&gt;!!</code>, etc.). It will not
"park" threads, like on the JVM.</p>
</div>
<div class="paragraph">
<p>Examples like the following may still work, but will take a lot more
system resources than on the JVM and will break down for some high value
of <code>n</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.core.async</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">async</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">cs</span><span class="w"> </span><span class="p">(</span><span class="nf">repeatedly</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">async/chan</span><span class="p">)</span><span class="w">
      </span><span class="n">begin</span><span class="w"> </span><span class="p">(</span><span class="nf">System/currentTimeMillis</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="n">cs</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">async/go</span><span class="w"> </span><span class="p">(</span><span class="nf">async/&gt;!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="s">"hi"</span><span class="p">)))</span><span class="w">
  </span><span class="p">(</span><span class="nb">dotimes</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="n">n</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">v</span><span class="w"> </span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">async/alts!!</span><span class="w"> </span><span class="n">cs</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"hi"</span><span class="w"> </span><span class="n">v</span><span class="p">))))</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"Read"</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="s">"msgs in"</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">System/currentTimeMillis</span><span class="p">)</span><span class="w"> </span><span class="n">begin</span><span class="p">)</span><span class="w"> </span><span class="s">"ms"</span><span class="p">))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interacting_with_an_nrepl_server">Interacting with an nREPL server</h3>
<div class="paragraph">
<p>Babashka comes with the <a href="https://github.com/nrepl/bencode">nrepl/bencode</a>
library which allows you to read and write bencode messages to a socket.
A simple example which evaluates a Clojure expression on an nREPL server
started with <code>lein repl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">nrepl-client</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">bencode.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">b</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">nrepl-eval</span><span class="w"> </span><span class="p">[</span><span class="n">port</span><span class="w"> </span><span class="n">expr</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="nf">java.net.Socket.</span><span class="w"> </span><span class="s">"localhost"</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w">
        </span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nf">.getOutputStream</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">
        </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">java.io.PushbackInputStream.</span><span class="w"> </span><span class="p">(</span><span class="nf">.getInputStream</span><span class="w"> </span><span class="n">s</span><span class="p">))</span><span class="w">
        </span><span class="n">_</span><span class="w"> </span><span class="p">(</span><span class="nf">b/write-bencode</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">{</span><span class="s">"op"</span><span class="w"> </span><span class="s">"eval"</span><span class="w"> </span><span class="s">"code"</span><span class="w"> </span><span class="n">expr</span><span class="p">})</span><span class="w">
        </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="p">(</span><span class="nf">b/read-bencode</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="s">"value"</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">String.</span><span class="w"> </span><span class="n">bytes</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">nrepl-eval</span><span class="w"> </span><span class="mi">52054</span><span class="w"> </span><span class="s">"(+ 1 2 3)"</span><span class="p">)</span><span class="w"> </span><span class="c1">;;=&gt; "6"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="differences-with-clojure">Differences with Clojure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Babashka is implemented using the <a href="https://github.com/borkdude/sci">Small
Clojure Interpreter</a>. This means that a snippet or script is not
compiled to JVM bytecode, but executed form by form by a runtime which
implements a substantial subset of Clojure. Babashka is compiled to a
native binary using <a href="https://github.com/oracle/graal">GraalVM</a>. It comes
with a selection of built-in namespaces and functions from Clojure and
other useful libraries. The data types (numbers, strings, persistent
collections) are the same. Multi-threading is supported (<code>pmap</code>,
<code>future</code>).</p>
</div>
<div class="paragraph">
<p>Differences with Clojure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A pre-selected set of Java classes are supported. You cannot add Java
classes at runtime.</p>
</li>
<li>
<p>Interpretation comes with overhead. Therefore loops are slower than in
Clojure on the JVM. In general interpretation yields slower programs
than compiled programs.</p>
</li>
<li>
<p>No <code>deftype</code>, <code>definterface</code> and unboxed math.</p>
</li>
<li>
<p><code>defprotocol</code> and <code>defrecord</code> are implemented using multimethods and
regular maps. Ostensibly they work the same, but under the hood there
are no Java classes that correspond to them.</p>
</li>
<li>
<p>Currently <code>reify</code> works only for one class at a time</p>
</li>
<li>
<p>The <code>clojure.core.async/go</code> macro is not (yet) supported. For
compatibility it currently maps to <code>clojure.core.async/thread</code>. More
info <a href="#core_async">here</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">License</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Copyright © 2020 Michiel Borkent</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.en_US"><img src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" alt="Creative Commons License"></a>
</div>
</div>
<div class="paragraph">
<p>This book is licensed under a
<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.en_US">Creative Commons
License</a>.</p>
</div>
<div class="paragraph">
<p>Please note that because this is a <strong>No Derivatives</strong> license, you may <strong>not</strong> use
this repository as a basis for creating your own book based on this one.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-11-28 21:49:36 +0100
</div>
</div>
</body>
</html>