<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Babashka book</title>
    <link rel="canonical" href="https://book.babashka.org/ROOT/child_processes.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="stylesheet" href="../_/css/site-extra.css">
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">-->
<!--<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">-->
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://book.babashka.org">Babashka book</a>
        <!--<span class="separator">//</span>
        <a href="https://book.babashka.org">Docs</a>-->
      </div>
      <!--<div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>-->
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <!--<div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider">CIDER</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/cider-nrepl">CIDER nREPL</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/orchard">Orchard</a>
              <a class="navbar-item" href="https://github.com/clojure-emacs/clojure-mode">clojure-mode</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/cider/about/support.html">Support</a>
            <a class="navbar-item" href="/cider/contributing.html">Contributing</a>
            <a class="navbar-item" href="https://opencollective.com/cider">Open Collective</a>
          </div>
        </div>
      </div>
    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="book.html">Babashka</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting_started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="usage.html">Usage</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/repl.html">Running a REPL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/classpath.html">Classpath</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/preloads.html">Preloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage/io-flags.html">Input and output flags</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="style.html">Style</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="libraries.html">Libraries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pods.html">Pods</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="child_processes.html">Child processes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deps_clj.html">Deps.clj</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="recipes.html">Recipes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="differences.html">Differences with Clojure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="contributing.html">Contributing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="license.html">License</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Babashka</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Babashka</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="book.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="intro.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="book.html">Babashka</a></li>
    <li><a href="child_processes.html">Child processes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/borkdude/Dropbox/dev/clojure/babashka.book/src/modules/ROOT/pages/child_processes.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="child_processes"><a class="anchor" href="#child_processes"></a>Child processes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>by Michiel Borkent</p>
</div>
<div class="paragraph">
<p>There are several ways of creating child processes in babashka. Let&#8217;s start with
the easiest one.</p>
</div>
<div class="sect2">
<h3 id="_clojure_java_shell"><a class="anchor" href="#_clojure_java_shell"></a>clojure.java.shell</h3>
<div class="paragraph">
<p>A common way to shell out to another process is via <code>clojure.java.shell</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">user=&gt; (require '[clojure.java.shell :refer [sh]])
nil
user=&gt; (sh "ls")
{:exit 0, :out "README.md\ndist\ngh-pages\nscript\nsrc\n", :err ""}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the result of <code>:out</code> are the lines of text produced by <code>ls</code>. The
<code>:exit</code> code was <code>0</code> and there was no output on stderr.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">user=&gt; (sh "ls" "foo")
{:exit 1, :out "", :err "ls: foo: No such file or directory\n"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we invoke <code>ls</code> with a non-existing file, there is error output, but not
output on stdout and the <code>:exit</code> code is <code>1</code>.</p>
</div>
<div class="paragraph">
<p>For more information on <code>clojure.java.shell</code>, read the
<a href="https://clojure.github.io/clojure/clojure.java.shell-api.html">API documentation</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_babashka_process"><a class="anchor" href="#_babashka_process"></a>babashka.process</h3>
<div class="paragraph">
<p>Creating a child process with <code>clojure.java.shell/sh</code> is convenient and
sufficient in 90% of the scripts you&#8217;re going to write with babashka. For the
remaining 10% you&#8217;re going to need something slightly more powerful. This is
where the <code>babashka.process</code> library namespace comes in. The README and source
code of this library is located <a href="https://github.com/babashka/process">here</a>.</p>
</div>
<div class="paragraph">
<p>What if we wanted to start a Clojure pREPL in our script, send commands to it
and read the evaluated output in a loop?  Using <code>clojure.java.shell/sh</code> for this
has the limitation that we can only send input and read output once per process.
Using <code>babashka.process</code> which leverages the <code>java.lang.ProcessBuilder</code> and
<code>java.lang.Process</code> classes gives us the extra power we need to overcome this
limitation.</p>
</div>
<div class="paragraph">
<p>First we show how to use <code>process</code> to start a process that inherits stdout,
stderr and stdin from the parent process. This is often useful when you want to
hand over control to another process at the end of a script. The following code
starts a pREPL process:</p>
</div>
<div class="listingblock">
<div class="title">process/prepl_1.clj</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">#!/usr/bin/env bb

(require '[babashka.process :as p])

(defn io-prepl []
  (let [cmd ["clojure" "-M"
             "-e" "(require '[clojure.core.server :as s])"
             "-e" "(s/io-prepl)"]                           <i class="conum" data-value="1"></i><b>(1)</b>
        proc (p/process cmd                                 <i class="conum" data-value="2"></i><b>(2)</b>
                        {:inherit true                      <i class="conum" data-value="3"></i><b>(3)</b>
                         :shutdown p/destroy-tree})]        <i class="conum" data-value="4"></i><b>(4)</b>
    proc))

@(io-prepl)                                                 <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command and its arguments</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creating the process</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This option redirects stdout and stdin from the parent process to the child
process.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This line will destroy the child process and all of it&#8217;s children processes
before the parent process exits.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dereferencing the process waits until it ends. If
we would not include this, our script would end immediately.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When calling the script, we can interact with the pREPL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ bb src/process/prepl_1.clj
(+ 1 2 3)
{:tag :ret, :val "6", :ns "user", :ms 5, :form "(+ 1 2 3)"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pressing ctrl-C or typing <code>:repl/quit</code> will make the script terminate.</p>
</div>
<div class="paragraph">
<p>What if we want to parse the output of the prepl and reformat it to our own
likings?  Instead of sending the output of the child process to stdout we will
have to get a hold of it. We can grab the output by not using <code>:inherit</code> and
getting the <code>:out</code> stream of the process. Similarly we will grab the <code>:in</code>
stream of the process and handle reading ourselves.</p>
</div>
<div class="listingblock">
<div class="title">process/prepl_2.clj</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">#!/usr/bin/env bb

(require '[babashka.process :as p])

(defn io-prepl []
  (let [cmd ["clojure" "-M"
             "-e" "(require '[clojure.core.server :as s])"
             "-e" "(s/io-prepl)"]
        proc (p/process cmd
                        {:shutdown p/destroy-tree})]
    proc))

(def prepl-process (io-prepl))

(require '[clojure.java.io :as io])

(def input-writer (io/writer (:in prepl-process)))        <i class="conum" data-value="1"></i><b>(1)</b>
(def output-reader (java.io.PushbackReader.
                    (io/reader (:out prepl-process))))    <i class="conum" data-value="2"></i><b>(2)</b>

(require '[clojure.edn :as edn])

(loop []
  (println "Type an expression to evaluate:")
  (when-let [v (read-line)]                               <i class="conum" data-value="3"></i><b>(3)</b>
    (binding [*out* input-writer]                         <i class="conum" data-value="4"></i><b>(4)</b>
      (println v))
    (let [next-val (edn/read {:eof ::EOF} output-reader)] <i class="conum" data-value="5"></i><b>(5)</b>
      (when-not (identical? ::EOF next-val)
        (println (:form next-val)                         <i class="conum" data-value="6"></i><b>(6)</b>
                 "evaluates to"
                 (:val next-val))
        (recur)))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A writer that we will use to send input to the pREPL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A reader that reads from the pREPL output. pREPL returns EDN and
<code>clojure.edn/read</code> needs a <code>PushbackReader</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We read user input via <code>clojure.core/read-line</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here we binding <code><strong>out</strong></code> to the input writer so we can use <code>println</code> to write
to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Read the next EDN value.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Print the output using our custom formatting.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ bb src/process/prepl_2.clj
Type an expression to evaluate:
(+ 1 2 3)
(+ 1 2 3) evaluates to 6
:repl/quit</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_real_world_examples"><a class="anchor" href="#_real_world_examples"></a>Real world examples</h4>
<div class="paragraph">
<p>Prior to <code>babashka.process</code> people were using raw <code>ProcessBuilder</code> interop. Here are some real world examples. These might get updated to <code>babashka.process</code> in the future.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/borkdude/babashka/blob/5608f935cd28c777cf7d16243574558e2203872e/script/bump_version.clj#L9">babashka</a> repo uses <code>ProcessBuilder</code> to invoke git to make a commit after bumping the version.
It redirects the output from <code>git</code> directly to stdout of the parent process.</p>
</li>
<li>
<p><a href="https://github.com/borkdude/babashka.curl/blob/53b5b9d98f2e594384f628b0deee76b53bea5062/src/babashka/curl.clj#L17">babashka.curl</a> uses <code>ProcessBuilder</code> to interact with the <code>curl</code> executable</p>
</li>
<li>
<p><a href="https://github.com/borkdude/deps.clj/blob/5d51b80176bdcb96927ce5e6aedb25581db0e2e0/deps.clj#L18">deps.clj</a>
uses <code>ProcessBuilder</code> to interact with <code>java</code>, e.g. to start a Clojure REPL or
compute a classpath using tools.deps</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2020 <a href="https://babashka.org">Michiel Borkent</a></p>
  <p>Except where otherwise noted, book.babashka.org is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons
Attribution-NonCommercial-NoDerivs</a> (CC BY-NC-ND 4.0).</p>
</footer>
<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script> -->
<!-- <script type="text/javascript"> -->
<!-- docsearch({ -->
<!--   apiKey: '1f3d78fd63fcb687dcc1312aab02a2de', -->
<!--   indexName: 'cider', -->
<!--   inputSelector: '#search-input', -->
<!--   algoliaOptions: { 'facetFilters': ["version:0.26"] }, -->
<!--   debug: false // Set debug to true if you want to inspect the dropdown -->
<!-- }); -->
<!-- </script> -->

<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
